<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://Ragnarokoo.github.io/LearningNotes/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html"><meta property="og:site_name" content="ğŸ“šå…¨æ ˆå¼€å‘å­¦ä¹ æŒ‡å—"><meta property="og:title" content="ThreadLocalå…¨é¢è§£æ"><meta property="og:description" content="å‰ç½®çŸ¥è¯† å…·æœ‰ä¸€å®šçš„javaseå’ŒjavawebåŸºç¡€; ç†Ÿæ‚‰synchronizedå…³é”®å­—; ç†Ÿæ‚‰HashMap; ç†Ÿæ‚‰ JDBCæŠ€æœ¯; å­¦ä¹ ç›®æ ‡ äº†è§£ThreadLocalçš„ä»‹ç» ; æŒæ¡ThreadLocalçš„è¿ç”¨åœºæ™¯; äº†è§£ThreadLocalçš„å†…éƒ¨ç»“æ„; äº†è§£ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç ; äº†è§£ThreadLocalMapçš„æºç ; 1..."><meta property="og:type" content="article"><meta property="og:image" content="https://Ragnarokoo.github.io/LearningNotes/"><meta property="og:updated_time" content="2023-05-31T09:16:41.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="ThreadLocalå…¨é¢è§£æ"><meta property="article:tag" content="Java"><meta property="article:modified_time" content="2023-05-31T09:16:41.000Z"><link rel="icon" href="/site_logo.svg"><title>ThreadLocalå…¨é¢è§£æ | ğŸ“šå…¨æ ˆå¼€å‘å­¦ä¹ æŒ‡å—</title><meta name="description" content="å‰ç½®çŸ¥è¯† å…·æœ‰ä¸€å®šçš„javaseå’ŒjavawebåŸºç¡€; ç†Ÿæ‚‰synchronizedå…³é”®å­—; ç†Ÿæ‚‰HashMap; ç†Ÿæ‚‰ JDBCæŠ€æœ¯; å­¦ä¹ ç›®æ ‡ äº†è§£ThreadLocalçš„ä»‹ç» ; æŒæ¡ThreadLocalçš„è¿ç”¨åœºæ™¯; äº†è§£ThreadLocalçš„å†…éƒ¨ç»“æ„; äº†è§£ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç ; äº†è§£ThreadLocalMapçš„æºç ; 1...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style.bc8b6d7c.css" as="style" /><link rel="stylesheet" href="/assets/style.bc8b6d7c.css" />
    <link rel="modulepreload" href="/assets/app.9b10ba0a.js"><link rel="modulepreload" href="/assets/ThreadLocalå…¨é¢è§£æ.html.60936857.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/ThreadLocalå…¨é¢è§£æ.html.2c017118.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/site_logo.svg" alt="ğŸ“šå…¨æ ˆå¼€å‘å­¦ä¹ æŒ‡å—"><!----><span class="site-name hide-in-pad">ğŸ“šå…¨æ ˆå¼€å‘å­¦ä¹ æŒ‡å—</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/quicknav/" class="nav-link" aria-label="å¿«é€Ÿå¯¼èˆª"><span class="icon iconfont icon-navigation"></span>å¿«é€Ÿå¯¼èˆª<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="åšå®¢ä¸»é¡µ"><span class="icon iconfont icon-blog"></span>åšå®¢ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/notes/" class="nav-link active" aria-label="Javaå­¦ä¹ æ•™ç¨‹"><span class="icon iconfont icon-java"></span>Javaå­¦ä¹ æ•™ç¨‹<!----></a></div><div class="nav-item hide-in-mobile"><a href="/web/" class="nav-link" aria-label="webå­¦ä¹ æ•™ç¨‹"><span class="icon iconfont icon-note"></span>webå­¦ä¹ æ•™ç¨‹<!----></a></div><div class="nav-item hide-in-mobile"><a href="/springcloud/" class="nav-link" aria-label="SpringCloudå­¦ä¹ æ•™ç¨‹"><span class="icon iconfont icon-cache"></span>SpringCloudå­¦ä¹ æ•™ç¨‹<!----></a></div><div class="nav-item hide-in-mobile"><a href="/distributed/" class="nav-link" aria-label="åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„"><span class="icon iconfont icon-read"></span>åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="èµ„æºå®åº“"><span class="title"><span class="icon iconfont icon-advance"></span>èµ„æºå®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/resources/books/" class="nav-link" aria-label="ä¹¦ç±èµ„æº"><span class="icon iconfont icon-animation"></span>ä¹¦ç±èµ„æº<!----></a></li><li class="dropdown-item"><a href="/resources/videos/" class="nav-link" aria-label="å½±éŸ³èµ„æº"><span class="icon iconfont icon-play"></span>å½±éŸ³èµ„æº<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/Ragnarokoo/LearningNotes" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢æœ¬ç«™" autocomplete="off" spellcheck="false" value><!----></form><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-java"></span><span class="title">Java Languageä¸“æ </span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/notes/javacore/java/01%E3%80%81JavaSE_Java%E8%AF%AD%E8%A8%80%E6%A6%82%E8%BF%B0.html" class="nav-link sidebar-link sidebar-page" aria-label="01ã€JavaSE_Javaè¯­è¨€æ¦‚è¿°"><!---->01ã€JavaSE_Javaè¯­è¨€æ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/02%E3%80%81%E5%8F%98%E9%87%8F&amp;%E6%A0%87%E8%AF%86%E7%AC%A6&amp;%E4%BF%9D%E7%95%99%E5%AD%97&amp;%E8%BF%9B%E5%88%B6.html" class="nav-link sidebar-link sidebar-page" aria-label="02ã€å˜é‡&amp;æ ‡è¯†ç¬¦&amp;ä¿ç•™å­—&amp;è¿›åˆ¶"><!---->02ã€å˜é‡&amp;æ ‡è¯†ç¬¦&amp;ä¿ç•™å­—&amp;è¿›åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/03%E3%80%81%E8%BF%90%E7%AE%97%E7%AC%A6.html" class="nav-link sidebar-link sidebar-page" aria-label="03ã€è¿ç®—ç¬¦"><!---->03ã€è¿ç®—ç¬¦<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/04%E3%80%81%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6.html" class="nav-link sidebar-link sidebar-page" aria-label="04ã€ç¨‹åºæµç¨‹æ§åˆ¶"><!---->04ã€ç¨‹åºæµç¨‹æ§åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/05%E3%80%81%E6%95%B0%E7%BB%84.html" class="nav-link sidebar-link sidebar-page" aria-label="05ã€æ•°ç»„"><!---->05ã€æ•°ç»„<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/06%E3%80%81%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%8A%EF%BC%89.html" class="nav-link sidebar-link sidebar-page" aria-label="06ã€é¢å‘å¯¹è±¡ï¼ˆä¸Šï¼‰"><!---->06ã€é¢å‘å¯¹è±¡ï¼ˆä¸Šï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/07%E3%80%81%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%AD%EF%BC%89.html" class="nav-link sidebar-link sidebar-page" aria-label="07ã€é¢å‘å¯¹è±¡ï¼ˆä¸­ï¼‰"><!---->07ã€é¢å‘å¯¹è±¡ï¼ˆä¸­ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/08%E3%80%81%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%8B%EF%BC%89.html" class="nav-link sidebar-link sidebar-page" aria-label="08ã€é¢å‘å¯¹è±¡ï¼ˆä¸‹ï¼‰"><!---->08ã€é¢å‘å¯¹è±¡ï¼ˆä¸‹ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/09%E3%80%81%E5%BC%82%E5%B8%B8.html" class="nav-link sidebar-link sidebar-page" aria-label="09ã€å¼‚å¸¸"><!---->09ã€å¼‚å¸¸<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/10%E3%80%81%E5%A4%9A%E7%BA%BF%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="10ã€å¤šçº¿ç¨‹"><!---->10ã€å¤šçº¿ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/11%E3%80%81%E5%B8%B8%E7%94%A8%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="11ã€å¸¸ç”¨ç±»"><!---->11ã€å¸¸ç”¨ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/12%E3%80%81%E6%9E%9A%E4%B8%BE%E7%B1%BB%E4%B8%8E%E6%B3%A8%E8%A7%A3.html" class="nav-link sidebar-link sidebar-page" aria-label="12ã€æšä¸¾ç±»ä¸æ³¨è§£"><!---->12ã€æšä¸¾ç±»ä¸æ³¨è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/13%E3%80%81%E9%9B%86%E5%90%88.html" class="nav-link sidebar-link sidebar-page" aria-label="13ã€é›†åˆ"><!---->13ã€é›†åˆ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/14%E3%80%81%E6%B3%9B%E5%9E%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="14ã€æ³›å‹"><!---->14ã€æ³›å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/15%E3%80%81IO%E6%B5%81.html" class="nav-link sidebar-link sidebar-page" aria-label="15ã€IOæµ"><!---->15ã€IOæµ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/16%E3%80%81%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="16ã€ç½‘ç»œç¼–ç¨‹"><!---->16ã€ç½‘ç»œç¼–ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/17%E3%80%81%E5%8F%8D%E5%B0%84%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.html" class="nav-link sidebar-link sidebar-page" aria-label="17ã€åå°„ä¸åŠ¨æ€ä»£ç†"><!---->17ã€åå°„ä¸åŠ¨æ€ä»£ç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/18%E3%80%81Java8%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8BLambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8EStream%20API.html" class="nav-link sidebar-link sidebar-page" aria-label="18ã€Java8æ–°ç‰¹æ€§ä¹‹Lambdaè¡¨è¾¾å¼ä¸Stream API"><!---->18ã€Java8æ–°ç‰¹æ€§ä¹‹Lambdaè¡¨è¾¾å¼ä¸Stream API<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/Java.html" class="nav-link sidebar-link sidebar-page" aria-label="Java Language Core Notes"><!---->Java Language Core Notes<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="ThreadLocalå…¨é¢è§£æ"><!---->ThreadLocalå…¨é¢è§£æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-threadlocalä»‹ç»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. ThreadLocalä»‹ç»"><!---->1. ThreadLocalä»‹ç»<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-1-å®˜æ–¹ä»‹ç»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 å®˜æ–¹ä»‹ç»"><!---->1.1 å®˜æ–¹ä»‹ç»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-2-åŸºæœ¬ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 åŸºæœ¬ä½¿ç”¨"><!---->1.2 åŸºæœ¬ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-3-threadlocalç±»ä¸synchronizedå…³é”®å­—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—"><!---->1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-è¿ç”¨åœºæ™¯-äº‹åŠ¡æ¡ˆä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹"><!---->2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-1-è½¬è´¦æ¡ˆä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 è½¬è´¦æ¡ˆä¾‹"><!---->2.1 è½¬è´¦æ¡ˆä¾‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-2-å¸¸è§„è§£å†³æ–¹æ¡ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2  å¸¸è§„è§£å†³æ–¹æ¡ˆ"><!---->2.2  å¸¸è§„è§£å†³æ–¹æ¡ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-3-threadlocalè§£å†³æ–¹æ¡ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ"><!---->2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-threadlocalçš„å†…éƒ¨ç»“æ„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. ThreadLocalçš„å†…éƒ¨ç»“æ„"><!---->3. ThreadLocalçš„å†…éƒ¨ç»“æ„<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-1-å¸¸è§çš„è¯¯è§£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1  å¸¸è§çš„è¯¯è§£"><!---->3.1  å¸¸è§çš„è¯¯è§£<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-2-ç°åœ¨çš„è®¾è®¡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2  ç°åœ¨çš„è®¾è®¡"><!---->3.2  ç°åœ¨çš„è®¾è®¡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-3-è¿™æ ·è®¾è®¡çš„å¥½å¤„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„"><!---->3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç "><!---->4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç <!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-1-setæ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 setæ–¹æ³•"><!---->4.1 setæ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-2-getæ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 getæ–¹æ³•"><!---->4.2 getæ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-3-removeæ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 removeæ–¹æ³•"><!---->4.3 removeæ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-4-initialvalueæ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4 initialValueæ–¹æ³•"><!---->4.4 initialValueæ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-threadlocalmapæºç åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. ThreadLocalMapæºç åˆ†æ"><!---->5. ThreadLocalMapæºç åˆ†æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-1-åŸºæœ¬ç»“æ„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1 åŸºæœ¬ç»“æ„"><!---->5.1 åŸºæœ¬ç»“æ„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-2-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼"><!---->5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-3-hashå†²çªçš„è§£å†³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.3 hashå†²çªçš„è§£å†³"><!---->5.3 hashå†²çªçš„è§£å†³<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/notes/javacore/java/%E5%BD%BB%E5%BA%95%E5%BC%84%E6%87%82StringBuffer%E4%B8%8EStringBuilder%E7%9A%84%E5%8C%BA%E5%88%AB.html" class="nav-link sidebar-link sidebar-page" aria-label="å½»åº•å¼„æ‡‚StringBufferä¸StringBuilderçš„åŒºåˆ«"><!---->å½»åº•å¼„æ‡‚StringBufferä¸StringBuilderçš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-IO"></span><span class="title">Javaç½‘ç»œç¼–ç¨‹NIO</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-community"></span><span class="title">JDBCæ•°æ®åº“è¿æ¥æŠ€æœ¯</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-categoryselected"></span><span class="title">JavaWeb</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-array"></span><span class="title">SSM Framework</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-geometry"></span><span class="title">SpringData</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-type"></span><span class="title">SpringBoot</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-module"></span><span class="title">mybatisplus</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-operate"></span><span class="title">æ„å»ºå·¥å…·&amp;äº‘åŸç”ŸDevops</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-mysql"></span><span class="title">æ•°æ®åº“ä»¥åŠè°ƒä¼˜ç­–ç•¥</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-quote"></span><span class="title">æ¶ˆæ¯ä¸­é—´ä»¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-tool"></span><span class="title">è½¯ä»¶ä»¥åŠç¯å¢ƒé…ç½®</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ability"></span><span class="title">Linuxæ“ä½œç³»ç»Ÿ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-rank"></span><span class="title">JUCé«˜å¹¶å‘ç¼–ç¨‹</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-mount"></span><span class="title">æ·±å…¥äº†è§£Javaè™šæ‹Ÿæœº</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-view"></span><span class="title">GOF23ç§è®¾è®¡æ¨¡å¼</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-tag"></span><span class="title">æŠ€æœ¯è¦ç‚¹ä¸šåŠ¡ç¯‡</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->ThreadLocalå…¨é¢è§£æ</h1><div class="page-info"><span class="category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li><span class="category category4 clickable" role="navigation">Java</span></li></ul><meta property="articleSection" content="Java"></span><span aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li><span class="tag tag4 clickable" role="navigation">Java</span></li></ul><meta property="keywords" content="Java"></span><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 28 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT28M"></span><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://github.com/Ragnarokoo/" target="_blank" rel="noopener noreferrer">Ragnarok</a></span><span property="author" content="Ragnarok"></span></span><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-31T09:16:41.000Z"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-threadlocalä»‹ç»" class="router-link-active router-link-exact-active toc-link level2">1. ThreadLocalä»‹ç»</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-1-å®˜æ–¹ä»‹ç»" class="router-link-active router-link-exact-active toc-link level3">1.1 å®˜æ–¹ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-2-åŸºæœ¬ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">1.2 åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_1-3-threadlocalç±»ä¸synchronizedå…³é”®å­—" class="router-link-active router-link-exact-active toc-link level3">1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-è¿ç”¨åœºæ™¯-äº‹åŠ¡æ¡ˆä¾‹" class="router-link-active router-link-exact-active toc-link level2">2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-1-è½¬è´¦æ¡ˆä¾‹" class="router-link-active router-link-exact-active toc-link level3">2.1 è½¬è´¦æ¡ˆä¾‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-2-å¸¸è§„è§£å†³æ–¹æ¡ˆ" class="router-link-active router-link-exact-active toc-link level3">2.2  å¸¸è§„è§£å†³æ–¹æ¡ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_2-3-threadlocalè§£å†³æ–¹æ¡ˆ" class="router-link-active router-link-exact-active toc-link level3">2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-threadlocalçš„å†…éƒ¨ç»“æ„" class="router-link-active router-link-exact-active toc-link level2">3. ThreadLocalçš„å†…éƒ¨ç»“æ„</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-1-å¸¸è§çš„è¯¯è§£" class="router-link-active router-link-exact-active toc-link level3">3.1  å¸¸è§çš„è¯¯è§£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-2-ç°åœ¨çš„è®¾è®¡" class="router-link-active router-link-exact-active toc-link level3">3.2  ç°åœ¨çš„è®¾è®¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_3-3-è¿™æ ·è®¾è®¡çš„å¥½å¤„" class="router-link-active router-link-exact-active toc-link level3">3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " class="router-link-active router-link-exact-active toc-link level2">4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç </a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-1-setæ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">4.1 setæ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-2-getæ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">4.2 getæ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-3-removeæ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">4.3 removeæ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_4-4-initialvalueæ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">4.4 initialValueæ–¹æ³•</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-threadlocalmapæºç åˆ†æ" class="router-link-active router-link-exact-active toc-link level2">5. ThreadLocalMapæºç åˆ†æ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-1-åŸºæœ¬ç»“æ„" class="router-link-active router-link-exact-active toc-link level3">5.1 åŸºæœ¬ç»“æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-2-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" class="router-link-active router-link-exact-active toc-link level3">5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/notes/javacore/java/ThreadLocal%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90.html#_5-3-hashå†²çªçš„è§£å†³" class="router-link-active router-link-exact-active toc-link level3">5.3 hashå†²çªçš„è§£å†³</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><p><strong>å‰ç½®çŸ¥è¯†</strong></p><ul><li>å…·æœ‰ä¸€å®šçš„javaseå’ŒjavawebåŸºç¡€</li><li>ç†Ÿæ‚‰synchronizedå…³é”®å­—</li><li>ç†Ÿæ‚‰HashMap</li><li>ç†Ÿæ‚‰ JDBCæŠ€æœ¯</li></ul><p><strong>å­¦ä¹ ç›®æ ‡</strong></p><ul><li><strong>äº†è§£ThreadLocalçš„ä»‹ç»</strong></li><li><strong>æŒæ¡ThreadLocalçš„è¿ç”¨åœºæ™¯</strong></li><li><strong>äº†è§£ThreadLocalçš„å†…éƒ¨ç»“æ„</strong></li><li><strong>äº†è§£ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç </strong></li><li><strong>äº†è§£ThreadLocalMapçš„æºç </strong></li></ul><h2 id="_1-threadlocalä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_1-threadlocalä»‹ç»" aria-hidden="true">#</a> 1. ThreadLocalä»‹ç»</h2><h3 id="_1-1-å®˜æ–¹ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_1-1-å®˜æ–¹ä»‹ç»" aria-hidden="true">#</a> 1.1 å®˜æ–¹ä»‹ç»</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * This class provides thread-local variables.  These variables differ from
 * their normal counterparts in that each thread that accesses one (via its
 * <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">get</span></span><span class="token punctuation">}</span> or <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">set</span></span><span class="token punctuation">}</span> method) has its own, independently initialized
 * copy of the variable.  <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span> instances are typically private
 * static fields in classes that wish to associate state with a thread (e.g.,
 * a user ID or Transaction ID).
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>For example, the class below generates unique identifiers local to each
 * thread.
 * A thread&#39;s id is assigned the first time it invokes <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">}</span>
 * and remains unchanged on subsequent calls.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>
 <span class="token code-section">* <span class="token line"><span class="token code language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span></span></span>
 *
 * <span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadId</span> <span class="token punctuation">{</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token comment">// Atomic integer containing the next thread ID to be assigned</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> nextId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *
 *     <span class="token line"><span class="token code language-java"><span class="token comment">// Thread local variable containing each thread&#39;s ID</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">&gt;</span></span><span class="token code language-java"> threadId <span class="token operator">=</span></span></span>
 *         <span class="token line"><span class="token code language-java"><span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Integer</span><span class="token punctuation">&gt;</span></span><span class="token code language-java"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span></span>
 *             <span class="token line"><span class="token entity" title="@">&amp;#64;</span><span class="token code language-java"><span class="token class-name">Override</span> <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span></span>
 *                 <span class="token line"><span class="token code language-java"><span class="token keyword">return</span> nextId<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *         <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></span>
 *
 *     <span class="token line"><span class="token code language-java"><span class="token comment">// Returns the current thread&#39;s unique ID, assigning it if necessary</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span></span>
 *         <span class="token line"><span class="token code language-java"><span class="token keyword">return</span> threadId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 * <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 *</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Each thread holds an implicit reference to its copy of a thread-local
 * variable as long as the thread is alive and the <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span>
 * instance is accessible; after a thread goes away, all of its copies of
 * thread-local instances are subject to garbage collection (unless other
 * references to these copies exist).
 *
 * <span class="token keyword">@author</span>  Josh Bloch and Doug Lea
 * <span class="token keyword">@since</span>   1.2
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">T</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ä»Javaå®˜æ–¹æ–‡æ¡£ä¸­çš„æè¿°ï¼šThreadLocalç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚è¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡getå’Œsetæ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯private staticç±»å‹çš„ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚</p><pre><code>   æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ ThreadLocal çš„ä½œç”¨æ˜¯ï¼šæä¾›çº¿ç¨‹å†…çš„å±€éƒ¨å˜é‡ï¼Œä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œè¿™ç§å˜é‡åœ¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå†…èµ·ä½œç”¨ï¼Œå‡å°‘åŒä¸€ä¸ªçº¿ç¨‹å†…å¤šä¸ªå‡½æ•°æˆ–ç»„ä»¶ä¹‹é—´ä¸€äº›å…¬å…±å˜é‡ä¼ é€’çš„å¤æ‚åº¦ã€‚
</code></pre><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>æ€»ç»“:
1. çº¿ç¨‹å¹¶å‘: åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹
2. ä¼ é€’æ•°æ®: æˆ‘ä»¬å¯ä»¥é€šè¿‡ThreadLocalåœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸åŒç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡
3. çº¿ç¨‹éš”ç¦»: æ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-2-åŸºæœ¬ä½¿ç”¨" aria-hidden="true">#</a> 1.2 åŸºæœ¬ä½¿ç”¨</h3><h4 id="_1-2-1-å¸¸ç”¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_1-2-1-å¸¸ç”¨æ–¹æ³•" aria-hidden="true">#</a> 1.2.1 å¸¸ç”¨æ–¹æ³•</h4><p>â€‹ åœ¨ä½¿ç”¨ä¹‹å‰,æˆ‘ä»¬å…ˆæ¥è®¤è¯†å‡ ä¸ªThreadLocalçš„å¸¸ç”¨æ–¹æ³•</p><table><thead><tr><th>æ–¹æ³•å£°æ˜</th><th>æè¿°</th></tr></thead><tbody><tr><td>ThreadLocal()</td><td>åˆ›å»ºThreadLocalå¯¹è±¡</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><h4 id="_1-2-2-ä½¿ç”¨æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#_1-2-2-ä½¿ç”¨æ¡ˆä¾‹" aria-hidden="true">#</a> 1.2.2 ä½¿ç”¨æ¡ˆä¾‹</h4><pre><code> æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹    , æ„Ÿå—ä¸€ä¸‹ThreadLocal çº¿ç¨‹éš”ç¦»çš„ç‰¹ç‚¹ï¼š 
</code></pre><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyDemo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    demo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;çš„æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;---&gt;&quot;</span> <span class="token operator">+</span> demo<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°ç»“æœ:</p><p><img src="data:image/png;base64,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" alt="1574149020726"></p><p>â€‹ ä»ç»“æœå¯ä»¥çœ‹å‡ºå¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™å‡ºç°çš„å¼‚å¸¸ï¼Œçº¿ç¨‹é—´çš„æ•°æ®æ²¡æœ‰éš”ç¦»ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹é‡‡ç”¨ ThreadLocal çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¾‹å­ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyDemo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    demo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;çš„æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;---&gt;&quot;</span> <span class="token operator">+</span> demo<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°ç»“æœ:</p><p>â€‹ <img src="data:image/png;base64,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" alt="1574149117289"></p><p>ä»ç»“æœæ¥çœ‹ï¼Œè¿™æ ·å¾ˆå¥½çš„è§£å†³äº†å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®éš”ç¦»çš„é—®é¢˜ï¼Œååˆ†æ–¹ä¾¿ã€‚</p><h3 id="_1-3-threadlocalç±»ä¸synchronizedå…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#_1-3-threadlocalç±»ä¸synchronizedå…³é”®å­—" aria-hidden="true">#</a> 1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—</h3><h4 id="_1-3-1-synchronizedåŒæ­¥æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_1-3-1-synchronizedåŒæ­¥æ–¹å¼" aria-hidden="true">#</a> 1.3.1 synchronizedåŒæ­¥æ–¹å¼</h4><p>â€‹ è¿™é‡Œå¯èƒ½æœ‰çš„æœ‹å‹ä¼šè§‰å¾—åœ¨ä¸Šè¿°ä¾‹å­ä¸­æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡åŠ é”æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ç”¨synchronizedä»£ç å—å®ç°çš„æ•ˆæœ:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo02</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Demo02</span> demo02 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo02</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Demo02</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        demo02<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;çš„æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-------------------------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> content <span class="token operator">=</span> demo02<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;---&gt;&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°ç»“æœ:</p><p>â€‹ <img src="/assets/007.ad0649c2.png" alt="1578321788844"></p><p>â€‹ ä»ç»“æœå¯ä»¥å‘ç°, åŠ é”ç¡®å®å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬å¼ºè°ƒçš„æ˜¯çº¿ç¨‹æ•°æ®éš”ç¦»çš„é—®é¢˜ï¼Œå¹¶ä¸æ˜¯å¤šçº¿ç¨‹å…±äº«æ•°æ®çš„é—®é¢˜, åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ä½¿ç”¨synchronizedå…³é”®å­—æ˜¯ä¸åˆé€‚çš„ã€‚</p><h4 id="_1-3-2-threadlocalä¸synchronizedçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_1-3-2-threadlocalä¸synchronizedçš„åŒºåˆ«" aria-hidden="true">#</a> 1.3.2 ThreadLocalä¸synchronizedçš„åŒºåˆ«</h4><p>â€‹ è™½ç„¶ThreadLocalæ¨¡å¼ä¸synchronizedå…³é”®å­—éƒ½ç”¨äºå¤„ç†å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å˜é‡çš„é—®é¢˜, ä¸è¿‡ä¸¤è€…å¤„ç†é—®é¢˜çš„è§’åº¦å’Œæ€è·¯ä¸åŒã€‚</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>åŸç†</td><td>åŒæ­¥æœºåˆ¶é‡‡ç”¨&#39;ä»¥æ—¶é—´æ¢ç©ºé—´&#39;çš„æ–¹å¼, åªæä¾›äº†ä¸€ä»½å˜é‡,è®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®</td><td>ThreadLocalé‡‡ç”¨&#39;ä»¥ç©ºé—´æ¢æ—¶é—´&#39;çš„æ–¹å¼, ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬,ä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œç›¸ä¸å¹²æ‰°</td></tr><tr><td>ä¾§é‡ç‚¹</td><td>å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥</td><td>å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</td></tr></tbody></table><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>æ€»ç»“ï¼š åœ¨åˆšåˆšçš„æ¡ˆä¾‹ä¸­ï¼Œè™½ç„¶ä½¿ç”¨ThreadLocalå’Œsynchronizedéƒ½èƒ½è§£å†³é—®é¢˜,ä½†æ˜¯ä½¿ç”¨ThreadLocalæ›´ä¸ºåˆé€‚,å› ä¸ºè¿™æ ·å¯ä»¥ä½¿ç¨‹åºæ‹¥æœ‰æ›´é«˜çš„å¹¶å‘æ€§ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-è¿ç”¨åœºæ™¯-äº‹åŠ¡æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-è¿ç”¨åœºæ™¯-äº‹åŠ¡æ¡ˆä¾‹" aria-hidden="true">#</a> 2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹</h2><p>â€‹ é€šè¿‡ä»¥ä¸Šçš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬äº†è§£ThreadLocalçš„ç‰¹ç‚¹ã€‚ä½†æ˜¯å®ƒå…·ä½“æ˜¯è¿ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸­å‘¢ï¼Ÿ æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæ¡ˆä¾‹ï¼š äº‹åŠ¡æ“ä½œã€‚</p><h3 id="_2-1-è½¬è´¦æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-1-è½¬è´¦æ¡ˆä¾‹" aria-hidden="true">#</a> 2.1 è½¬è´¦æ¡ˆä¾‹</h3><h4 id="_2-1-1-åœºæ™¯æ„å»º" tabindex="-1"><a class="header-anchor" href="#_2-1-1-åœºæ™¯æ„å»º" aria-hidden="true">#</a> 2.1.1 åœºæ™¯æ„å»º</h4><p>â€‹ è¿™é‡Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•çš„è½¬è´¦åœºæ™¯ï¼š æœ‰ä¸€ä¸ªæ•°æ®è¡¨accountï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªç”¨æˆ·Jackå’ŒRoseï¼Œç”¨æˆ·Jack ç»™ç”¨æˆ·Rose è½¬è´¦ã€‚</p><p>â€‹ æ¡ˆä¾‹çš„å®ç°ä¸»è¦ç”¨mysqlæ•°æ®åº“ï¼ŒJDBC å’Œ C3P0 æ¡†æ¶ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†ä»£ç  ï¼š</p><p>â€‹ ï¼ˆ1ï¼‰ é¡¹ç›®ç»“æ„</p><p><img src="/assets/001.394275c3.png" alt="1574045241145"></p><p>â€‹ ï¼ˆ2ï¼‰ æ•°æ®å‡†å¤‡</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- ä½¿ç”¨æ•°æ®åº“</span>
<span class="token keyword">use</span> test<span class="token punctuation">;</span>
<span class="token comment">-- åˆ›å»ºä¸€å¼ è´¦æˆ·è¡¨</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> account<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    money <span class="token keyword">double</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- åˆå§‹åŒ–æ•°æ®</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> account <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">&#39;Jack&#39;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> account <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">&#39;Rose&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ3ï¼‰ C3P0é…ç½®æ–‡ä»¶å’Œå·¥å…·ç±»</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>c3p0-config</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- ä½¿ç”¨é»˜è®¤çš„é…ç½®è¯»å–è¿æ¥æ± å¯¹è±¡ --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default-config</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--  è¿æ¥å‚æ•° --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driverClass<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.mysql.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbcUrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>jdbc:mysql://localhost:3306/test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1234<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- è¿æ¥æ± å‚æ•° --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>initialPoolSize<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>maxPoolSize<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkoutTimeout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default-config</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>c3p0-config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ4ï¼‰ å·¥å…·ç±» ï¼š JdbcUtils</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mchange<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>c3p0<span class="token punctuation">.</span></span><span class="token class-name">ComboPooledDataSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">// c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ComboPooledDataSource</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–è¿æ¥</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//é‡Šæ”¾èµ„æº</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token class-name">AutoCloseable</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ios<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseable</span> io <span class="token operator">:</span> ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>io <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    io<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">commitAndClose</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//æäº¤äº‹åŠ¡</span>
                conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//é‡Šæ”¾è¿æ¥</span>
                conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rollbackAndClose</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//å›æ»šäº‹åŠ¡</span>
                conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//é‡Šæ”¾è¿æ¥</span>
                conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ5ï¼‰ daoå±‚ä»£ç  ï¼š AccountDao</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money - ? where name = ?&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>outUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money + ? where name = ?&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>inUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ6ï¼‰ serviceå±‚ä»£ç  ï¼š AccountService</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">AccountDao</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccountDao</span> ad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è½¬å‡º</span>
            ad<span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>outUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è½¬å…¥</span>
            ad<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>inUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ7ï¼‰ webå±‚ä»£ç  ï¼š AccountWeb</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">AccountService</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountWeb</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¨¡æ‹Ÿæ•°æ® : Jack ç»™ Rose è½¬è´¦ 100</span>
        <span class="token class-name">String</span> outUser <span class="token operator">=</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> inUser <span class="token operator">=</span> <span class="token string">&quot;Rose&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> money <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

        <span class="token class-name">AccountService</span> as <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> as<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>outUser<span class="token punctuation">,</span> inUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è½¬è´¦å¤±è´¥!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è½¬è´¦æˆåŠŸ!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-1-2-å¼•å…¥äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_2-1-2-å¼•å…¥äº‹åŠ¡" aria-hidden="true">#</a> 2.1.2 å¼•å…¥äº‹åŠ¡</h4><p>â€‹ æ¡ˆä¾‹ä¸­çš„è½¬è´¦æ¶‰åŠä¸¤ä¸ªDMLæ“ä½œï¼š ä¸€ä¸ªè½¬å‡ºï¼Œä¸€ä¸ªè½¬å…¥ã€‚è¿™äº›æ“ä½œæ˜¯éœ€è¦å…·å¤‡åŸå­æ€§çš„ï¼Œä¸å¯åˆ†å‰²ã€‚ä¸ç„¶å°±æœ‰å¯èƒ½å‡ºç°æ•°æ®ä¿®æ”¹å¼‚å¸¸æƒ…å†µã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccountDao</span> ad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è½¬å‡º</span>
            ad<span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>outUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// è½¬å…¥</span>
            ad<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>inUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ æ‰€ä»¥è¿™é‡Œå°±éœ€è¦æ“ä½œäº‹åŠ¡ï¼Œæ¥ä¿è¯è½¬å‡ºå’Œè½¬å…¥æ“ä½œå…·å¤‡åŸå­æ€§ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚</p><p>ï¼ˆ1ï¼‰ JDBCä¸­å…³äºäº‹åŠ¡çš„æ“ä½œçš„api</p><table><thead><tr><th>Connectionæ¥å£çš„æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>void setAutoCommit(false)</td><td>ç¦ç”¨äº‹åŠ¡è‡ªåŠ¨æäº¤ï¼ˆæ”¹ä¸ºæ‰‹åŠ¨ï¼‰</td></tr><tr><td>void commit();</td><td>æäº¤äº‹åŠ¡</td></tr><tr><td>void rollback();</td><td>å›æ»šäº‹åŠ¡</td></tr></tbody></table><p><strong>ï¼ˆ2ï¼‰ å¼€å¯äº‹åŠ¡çš„æ³¨æ„ç‚¹:</strong></p><ul><li><p>ä¸ºäº†ä¿è¯æ‰€æœ‰çš„æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­,æ¡ˆä¾‹ä¸­ä½¿ç”¨çš„è¿æ¥å¿…é¡»æ˜¯åŒä¸€ä¸ª: serviceå±‚å¼€å¯äº‹åŠ¡çš„connectionéœ€è¦è·Ÿdaoå±‚è®¿é—®æ•°æ®åº“çš„connectionä¿æŒä¸€è‡´</p></li><li><p>çº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹, æ¯ä¸ªçº¿ç¨‹åªèƒ½æ“ä½œå„è‡ªçš„ connection</p></li></ul><h3 id="_2-2-å¸¸è§„è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#_2-2-å¸¸è§„è§£å†³æ–¹æ¡ˆ" aria-hidden="true">#</a> 2.2 å¸¸è§„è§£å†³æ–¹æ¡ˆ</h3><p><img src="/assets/111.8df4ce1c.png" alt="111"></p><h4 id="_2-2-1-å¸¸è§„æ–¹æ¡ˆçš„å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-2-1-å¸¸è§„æ–¹æ¡ˆçš„å®ç°" aria-hidden="true">#</a> 2.2.1 å¸¸è§„æ–¹æ¡ˆçš„å®ç°</h4><p>åŸºäºä¸Šé¢ç»™å‡ºçš„å‰æï¼Œ å¤§å®¶é€šå¸¸æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ ï¼š</p><ul><li>ä¼ å‚: ä»serviceå±‚å°†connectionå¯¹è±¡å‘daoå±‚ä¼ é€’</li><li>åŠ é”</li></ul><p>ä»¥ä¸‹æ˜¯ä»£ç å®ç°ä¿®æ”¹çš„éƒ¨åˆ†ï¼š</p><p>â€‹ ï¼ˆ1 ) AccountService ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">AccountDao</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccountDao</span> ad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//çº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹,ä¸ºäº†ä¿è¯æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªçš„connection,æ•…åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">AccountService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//å¼€å¯äº‹åŠ¡</span>
                conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è½¬å‡º</span>
                ad<span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> outUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span>
<span class="token comment">//            int i = 1/0;</span>
                <span class="token comment">// è½¬å…¥</span>
                ad<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> inUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//äº‹åŠ¡æäº¤</span>
                <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">commitAndClose</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//äº‹åŠ¡å›æ»š</span>
                <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">rollbackAndClose</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ2) AccountDao ç±» ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š connectionä¸èƒ½åœ¨daoå±‚é‡Šæ”¾ï¼Œè¦åœ¨serviceå±‚ï¼Œä¸ç„¶åœ¨daoå±‚é‡Šæ”¾ï¼Œserviceå±‚å°±æ— æ³•ä½¿ç”¨äº†ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">,</span> <span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money - ? where name = ?&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//æ³¨é‡Šä»è¿æ¥æ± è·å–è¿æ¥çš„ä»£ç ,ä½¿ç”¨ä»serviceä¸­ä¼ é€’è¿‡æ¥çš„connection</span>
<span class="token comment">//        Connection conn = JdbcUtils.getConnection();</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>outUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿æ¥ä¸èƒ½åœ¨è¿™é‡Œé‡Šæ”¾,serviceå±‚ä¸­è¿˜éœ€è¦ä½¿ç”¨</span>
<span class="token comment">//        JdbcUtils.release(pstm,conn);</span>
        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">,</span> <span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money + ? where name = ?&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//        Connection conn = JdbcUtils.getConnection();</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>inUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        JdbcUtils.release(pstm,conn);</span>
        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯" tabindex="-1"><a class="header-anchor" href="#_2-2-2-å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯" aria-hidden="true">#</a> 2.2.2 å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯</h4><p>ä¸Šè¿°æ–¹å¼æˆ‘ä»¬çœ‹åˆ°çš„ç¡®æŒ‰è¦æ±‚è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°è¿™æ ·å®ç°çš„å¼Šç«¯ï¼š</p><ol><li><p>ç›´æ¥ä»serviceå±‚ä¼ é€’connectionåˆ°daoå±‚, é€ æˆä»£ç è€¦åˆåº¦æé«˜</p></li><li><p>åŠ é”ä¼šé€ æˆçº¿ç¨‹å¤±å»å¹¶å‘æ€§ï¼Œç¨‹åºæ€§èƒ½é™ä½</p></li></ol><h3 id="_2-3-threadlocalè§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#_2-3-threadlocalè§£å†³æ–¹æ¡ˆ" aria-hidden="true">#</a> 2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ</h3><p><img src="/assets/222.d71e3ae6.png" alt="image-20230411234934220"></p><h4 id="_2-3-1-threadlocalæ–¹æ¡ˆçš„å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-3-1-threadlocalæ–¹æ¡ˆçš„å®ç°" aria-hidden="true">#</a> 2.3.1 ThreadLocalæ–¹æ¡ˆçš„å®ç°</h4><p>åƒè¿™ç§éœ€è¦åœ¨é¡¹ç›®ä¸­è¿›è¡Œ<strong>æ•°æ®ä¼ é€’</strong>å’Œ<strong>çº¿ç¨‹éš”ç¦»</strong>çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä¸å¦¨ç”¨ThreadLocalæ¥è§£å†³ï¼š</p><p>â€‹ ï¼ˆ1ï¼‰ å·¥å…·ç±»çš„ä¿®æ”¹ï¼š åŠ å…¥ThreadLocal</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mchange<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>c3p0<span class="token punctuation">.</span></span><span class="token class-name">ComboPooledDataSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">//ThreadLocalå¯¹è±¡ : å°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Connection</span> <span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ComboPooledDataSource</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è·å–è¿æ¥</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º</span>
            conn <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­</span>
            tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//é‡Šæ”¾èµ„æº</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token class-name">AutoCloseable</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseable</span> io <span class="token operator">:</span> ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>io <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    io<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">commitAndClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æäº¤äº‹åŠ¡</span>
            conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è§£é™¤ç»‘å®š</span>
            tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//é‡Šæ”¾è¿æ¥</span>
            conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rollbackAndClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å›æ»šäº‹åŠ¡</span>
            conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è§£é™¤ç»‘å®š</span>
            tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//é‡Šæ”¾è¿æ¥</span>
            conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ2ï¼‰ AccountServiceç±»çš„ä¿®æ”¹ï¼šä¸éœ€è¦ä¼ é€’connectionå¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">AccountDao</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccountDao</span> ad <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¼€å¯äº‹åŠ¡</span>
            conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è½¬å‡º ï¼š è¿™é‡Œä¸éœ€è¦ä¼ å‚äº† ï¼</span>
            ad<span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>outUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span>
<span class="token comment">//            int i = 1 / 0;</span>
            <span class="token comment">// è½¬å…¥</span>
            ad<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>inUser<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//äº‹åŠ¡æäº¤</span>
            <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">commitAndClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//äº‹åŠ¡å›æ»š</span>
           <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">rollbackAndClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ï¼ˆ3ï¼‰ AccountDaoç±»çš„ä¿®æ”¹ï¼šç…§å¸¸ä½¿ç”¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">String</span> outUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money - ? where name = ?&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>outUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ç…§å¸¸ä½¿ç”¨</span>
<span class="token comment">//        JdbcUtils.release(pstm,conn);</span>
        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">String</span> inUser<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;update account set money = money + ? where name = ?&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pstm <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>inUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pstm<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        JdbcUtils.release(pstm,conn);</span>
        <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>pstm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-threadlocalæ–¹æ¡ˆçš„å¥½å¤„" tabindex="-1"><a class="header-anchor" href="#_2-3-2-threadlocalæ–¹æ¡ˆçš„å¥½å¤„" aria-hidden="true">#</a> 2.3.2 ThreadLocalæ–¹æ¡ˆçš„å¥½å¤„</h4><p>ä»ä¸Šè¿°çš„æ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ï¼ŒThreadLocalæ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š</p><ol><li><p>ä¼ é€’æ•°æ® ï¼š ä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–, é¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜</p></li><li><p>çº¿ç¨‹éš”ç¦» ï¼š å„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±</p></li></ol><h2 id="_3-threadlocalçš„å†…éƒ¨ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_3-threadlocalçš„å†…éƒ¨ç»“æ„" aria-hidden="true">#</a> 3. ThreadLocalçš„å†…éƒ¨ç»“æ„</h2><p>â€‹ é€šè¿‡ä»¥ä¸Šçš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹ThreadLocalçš„ä½œç”¨æœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚ç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ThreadLocalçš„å†…éƒ¨ç»“æ„ï¼Œæ¢ç©¶å®ƒèƒ½å¤Ÿå®ç°çº¿ç¨‹æ•°æ®éš”ç¦»çš„åŸç†ã€‚</p><h3 id="_3-1-å¸¸è§çš„è¯¯è§£" tabindex="-1"><a class="header-anchor" href="#_3-1-å¸¸è§çš„è¯¯è§£" aria-hidden="true">#</a> 3.1 å¸¸è§çš„è¯¯è§£</h3><p>â€‹ å¦‚æœæˆ‘ä»¬ä¸å»çœ‹æºä»£ç çš„è¯ï¼Œå¯èƒ½ä¼šçŒœæµ‹<code>ThreadLocal</code>æ˜¯è¿™æ ·å­è®¾è®¡çš„ï¼šæ¯ä¸ª<code>ThreadLocal</code>éƒ½åˆ›å»ºä¸€ä¸ª<code>Map</code>ï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º<code>Map</code>çš„<code>key</code>ï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º<code>Map</code>çš„<code>value</code>ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™æ˜¯æœ€ç®€å•çš„è®¾è®¡æ–¹æ³•ï¼ŒJDKæœ€æ—©æœŸçš„<code>ThreadLocal</code> ç¡®å®æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œä½†ç°åœ¨æ—©å·²ä¸æ˜¯äº†ã€‚</p><p><img src="/assets/008.f14b6643.png" alt="1582788729557"></p><h3 id="_3-2-ç°åœ¨çš„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#_3-2-ç°åœ¨çš„è®¾è®¡" aria-hidden="true">#</a> 3.2 ç°åœ¨çš„è®¾è®¡</h3><p>â€‹ ä½†æ˜¯ï¼ŒJDKåé¢ä¼˜åŒ–äº†è®¾è®¡æ–¹æ¡ˆï¼Œåœ¨JDK8ä¸­ <code>ThreadLocal</code>çš„è®¾è®¡æ˜¯ï¼šæ¯ä¸ª<code>Thread</code>ç»´æŠ¤ä¸€ä¸ª<code>ThreadLocalMap</code>ï¼Œè¿™ä¸ªMapçš„<code>key</code>æ˜¯<code>ThreadLocal</code>å®ä¾‹æœ¬èº«ï¼Œ<code>value</code>æ‰æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼<code>Object</code>ã€‚</p><p>å…·ä½“çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>ï¼ˆ1ï¼‰ æ¯ä¸ªThreadçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMap (ThreadLocalMap)</p><p>ï¼ˆ2ï¼‰ Mapé‡Œé¢å­˜å‚¨ThreadLocalå¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ˆvalueï¼‰</p><p>ï¼ˆ3ï¼‰Threadå†…éƒ¨çš„Mapæ˜¯ç”±ThreadLocalç»´æŠ¤çš„ï¼Œç”±ThreadLocalè´Ÿè´£å‘mapè·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼ã€‚</p><p>ï¼ˆ4ï¼‰å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆäº†å‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚</p><p><img src="/assets/004.c816aac0.png" alt="1574155226793"></p><h3 id="_3-3-è¿™æ ·è®¾è®¡çš„å¥½å¤„" tabindex="-1"><a class="header-anchor" href="#_3-3-è¿™æ ·è®¾è®¡çš„å¥½å¤„" aria-hidden="true">#</a> 3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„</h3><p>â€‹ è¿™ä¸ªè®¾è®¡ä¸æˆ‘ä»¬ä¸€å¼€å§‹è¯´çš„è®¾è®¡åˆšå¥½ç›¸åï¼Œè¿™æ ·è®¾è®¡æœ‰å¦‚ä¸‹ä¸¤ä¸ªä¼˜åŠ¿ï¼š</p><p>ï¼ˆ1ï¼‰ è¿™æ ·è®¾è®¡ä¹‹åæ¯ä¸ª<code>Map</code>å­˜å‚¨çš„<code>Entry</code>æ•°é‡å°±ä¼šå˜å°‘ã€‚å› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”±<code>Thread</code>çš„æ•°é‡å†³å®šï¼Œç°åœ¨æ˜¯ç”±<code>ThreadLocal</code>çš„æ•°é‡å†³å®šã€‚åœ¨å®é™…è¿ç”¨å½“ä¸­ï¼Œå¾€å¾€ThreadLocalçš„æ•°é‡è¦å°‘äºThreadçš„æ•°é‡ã€‚</p><p>ï¼ˆ2ï¼‰ å½“<code>Thread</code>é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„<code>ThreadLocalMap</code>ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</p><p><img src="/assets/333.fe172ab3.png" alt="image-20230411235057185"></p><h2 id="_4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " tabindex="-1"><a class="header-anchor" href="#_4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " aria-hidden="true">#</a> 4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç </h2><p>â€‹ åŸºäºThreadLocalçš„å†…éƒ¨ç»“æ„ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æå®ƒçš„æ ¸å¿ƒæ–¹æ³•æºç ï¼Œæ›´æ·±å…¥çš„äº†è§£å…¶æ“ä½œåŸç†ã€‚</p><p>é™¤äº†æ„é€ æ–¹æ³•ä¹‹å¤–ï¼Œ ThreadLocalå¯¹å¤–æš´éœ²çš„æ–¹æ³•æœ‰ä»¥ä¸‹4ä¸ªï¼š</p><table><thead><tr><th>æ–¹æ³•å£°æ˜</th><th>æè¿°</th></tr></thead><tbody><tr><td>protected T initialValue()</td><td>è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><p>â€‹ ä»¥ä¸‹æ˜¯è¿™4ä¸ªæ–¹æ³•çš„è¯¦ç»†æºç åˆ†æ(ä¸ºäº†ä¿è¯æ€è·¯æ¸…æ™°, ThreadLocalMapéƒ¨åˆ†æš‚æ—¶ä¸å±•å¼€,ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹è¯¦è§£)</p><h3 id="_4-1-setæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_4-1-setæ–¹æ³•" aria-hidden="true">#</a> 4.1 setæ–¹æ³•</h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token doc-comment comment">/**
     * è®¾ç½®å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„å€¼
     *
     * <span class="token keyword">@param</span> <span class="token parameter">value</span> å°†è¦ä¿å­˜åœ¨å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„å€¼
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// 1ï¼‰å½“å‰çº¿ç¨‹Thread ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡</span>
            <span class="token comment">// 2ï¼‰åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span>
            <span class="token comment">// 3ï¼‰å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
     * è·å–å½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap 
     * 
     * <span class="token keyword">@param</span>  <span class="token parameter">t</span> the current thread å½“å‰çº¿ç¨‹
     * <span class="token keyword">@return</span> the map å¯¹åº”ç»´æŠ¤çš„ThreadLocalMap 
     */</span>
    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     *åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap 
     *
     * <span class="token keyword">@param</span> <span class="token parameter">t</span> å½“å‰çº¿ç¨‹
     * <span class="token keyword">@param</span> <span class="token parameter">firstValue</span> å­˜æ”¾åˆ°mapä¸­ç¬¬ä¸€ä¸ªentryçš„å€¼
     */</span>
    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è¿™é‡Œçš„thisæ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„threadLocal</span>
        t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2 ) ä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>â€‹ A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹ B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ°Mapä¸­ï¼ˆå½“å‰ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyï¼‰</p><p>â€‹ C. å¦‚æœMapä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º Mapï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</p><h3 id="_4-2-getæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_4-2-getæ–¹æ³•" aria-hidden="true">#</a> 4.2 getæ–¹æ³•</h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * è¿”å›å½“å‰çº¿ç¨‹ä¸­ä¿å­˜ThreadLocalçš„å€¼
     * å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰æ­¤ThreadLocalå˜é‡ï¼Œ
     * åˆ™å®ƒä¼šé€šè¿‡è°ƒç”¨<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">initialValue</span></span><span class="token punctuation">}</span> æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å€¼
     *
     * <span class="token keyword">@return</span> è¿”å›å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ­¤mapå­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä»¥å½“å‰çš„ThreadLocal ä¸º keyï¼Œè°ƒç”¨getEntryè·å–å¯¹åº”çš„å­˜å‚¨å®ä½“e</span>
            <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¯¹eè¿›è¡Œåˆ¤ç©º </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span>
                <span class="token comment">// å³ä¸ºæˆ‘ä»¬æƒ³è¦çš„å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼</span>
                <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*
            åˆå§‹åŒ– : æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç 
            ç¬¬ä¸€ç§æƒ…å†µ: mapä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡
            ç¬¬äºŒç§æƒ…å†µ: mapå­˜åœ¨, ä½†æ˜¯æ²¡æœ‰ä¸å½“å‰ThreadLocalå…³è”çš„entry
         */</span>
        <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * åˆå§‹åŒ–
     *
     * <span class="token keyword">@return</span> the initial value åˆå§‹åŒ–åçš„å€¼
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼</span>
        <span class="token comment">// æ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å›null</span>
        <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// 1ï¼‰å½“å‰çº¿ç¨‹Thread ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡</span>
            <span class="token comment">// 2ï¼‰åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span>
            <span class="token comment">// 3ï¼‰å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿”å›è®¾ç½®çš„å€¼value</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2 ) ä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>â€‹ A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹, æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹ B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™åœ¨Mapä¸­ä»¥ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyæ¥åœ¨Mapä¸­è·å–å¯¹åº”çš„Entry eï¼Œå¦åˆ™è½¬åˆ°D</p><p>â€‹ C. å¦‚æœeä¸ä¸ºnullï¼Œåˆ™è¿”å›e.valueï¼Œå¦åˆ™è½¬åˆ°D</p><p>â€‹ D. Mapä¸ºç©ºæˆ–è€…eä¸ºç©ºï¼Œåˆ™é€šè¿‡initialValueå‡½æ•°è·å–åˆå§‹å€¼valueï¼Œç„¶åç”¨ThreadLocalçš„å¼•ç”¨å’Œvalueä½œä¸ºfirstKeyå’ŒfirstValueåˆ›å»ºä¸€ä¸ªæ–°çš„Map</p><p>æ€»ç»“: <strong>å…ˆè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å˜é‡ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å€¼ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºå¹¶è¿”å›åˆå§‹å€¼ã€‚</strong></p><h3 id="_4-3-removeæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_4-3-removeæ–¹æ³•" aria-hidden="true">#</a> 4.3 removeæ–¹æ³•</h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * åˆ é™¤å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„ThreadLocalå¯¹åº”çš„å®ä½“entry
     */</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span>
         <span class="token class-name">ThreadLocalMap</span> m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ­¤mapå­˜åœ¨</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨map.remove</span>
            <span class="token comment">// ä»¥å½“å‰ThreadLocalä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“entry</span>
             m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2 ) ä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>â€‹ A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹ B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™ç§»é™¤å½“å‰ThreadLocalå¯¹è±¡å¯¹åº”çš„entry</p><h3 id="_4-4-initialvalueæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_4-4-initialvalueæ–¹æ³•" aria-hidden="true">#</a> <strong>4.4 initialValueæ–¹æ³•</strong></h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * è¿”å›å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„åˆå§‹å€¼

  * æ­¤æ–¹æ³•çš„ç¬¬ä¸€æ¬¡è°ƒç”¨å‘ç”Ÿåœ¨ï¼Œå½“çº¿ç¨‹é€šè¿‡getæ–¹æ³•è®¿é—®æ­¤çº¿ç¨‹çš„ThreadLocalå€¼æ—¶
  * é™¤éçº¿ç¨‹å…ˆè°ƒç”¨äº†setæ–¹æ³•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒinitialValue æ‰ä¸ä¼šè¢«è¿™ä¸ªçº¿ç¨‹è°ƒç”¨ã€‚
  * é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤šè°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•ã€‚
  *
  * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è¿™ä¸ªæ–¹æ³•ä»…ä»…ç®€å•çš„è¿”å›null <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>;
  * å¦‚æœç¨‹åºå‘˜æƒ³ThreadLocalçº¿ç¨‹å±€éƒ¨å˜é‡æœ‰ä¸€ä¸ªé™¤nullä»¥å¤–çš„åˆå§‹å€¼ï¼Œ
  * å¿…é¡»é€šè¿‡å­ç±»ç»§æ‰¿<span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span> çš„æ–¹å¼å»é‡å†™æ­¤æ–¹æ³•
  * é€šå¸¸, å¯ä»¥é€šè¿‡åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼å®ç°
  *
  * <span class="token keyword">@return</span> å½“å‰ThreadLocalçš„åˆå§‹å€¼
  */</span>
<span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯ è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ã€‚</p><p>ï¼ˆ1ï¼‰ è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¾—çŸ¥ï¼Œåœ¨setæ–¹æ³•è¿˜æœªè°ƒç”¨è€Œå…ˆè°ƒç”¨äº†getæ–¹æ³•æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚</p><p>ï¼ˆ2ï¼‰è¿™ä¸ªæ–¹æ³•ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ª<code>null</code>ã€‚</p><p>ï¼ˆ3ï¼‰å¦‚æœæƒ³è¦ä¸€ä¸ªé™¤nullä¹‹å¤–çš„åˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ã€‚ï¼ˆå¤‡æ³¨ï¼š è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª<code>protected</code>çš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ï¼‰</p><h2 id="_5-threadlocalmapæºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_5-threadlocalmapæºç åˆ†æ" aria-hidden="true">#</a> 5. ThreadLocalMapæºç åˆ†æ</h2><p>â€‹ åœ¨åˆ†æThreadLocalæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬äº†è§£åˆ°ThreadLocalçš„æ“ä½œå®é™…ä¸Šæ˜¯å›´ç»•ThreadLocalMapå±•å¼€çš„ã€‚ThreadLocalMapçš„æºç ç›¸å¯¹æ¯”è¾ƒå¤æ‚, æˆ‘ä»¬ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢è¿›è¡Œè®¨è®ºã€‚</p><h3 id="_5-1-åŸºæœ¬ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_5-1-åŸºæœ¬ç»“æ„" aria-hidden="true">#</a> 5.1 åŸºæœ¬ç»“æ„</h3><p>â€‹ ThreadLocalMapæ˜¯ThreadLocalçš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç°Mapæ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº†Mapçš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨çš„Entryä¹Ÿæ˜¯ç‹¬ç«‹å®ç°ã€‚</p><p><img src="/assets/005.cd455e0c.png" alt="1574266262577"></p><p><strong>ï¼ˆ1ï¼‰ æˆå‘˜å˜é‡</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * åˆå§‹å®¹é‡ â€”â€” å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å­˜æ”¾æ•°æ®çš„tableï¼ŒEntryç±»çš„å®šä¹‰åœ¨ä¸‹é¢åˆ†æ
     * åŒæ ·ï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ•°ç»„é‡Œé¢entrysçš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­tableå½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span> <span class="token comment">// Default to 0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ è·ŸHashMapç±»ä¼¼ï¼ŒINITIAL_CAPACITYä»£è¡¨è¿™ä¸ªMapçš„åˆå§‹å®¹é‡ï¼›table æ˜¯ä¸€ä¸ªEntry ç±»å‹çš„æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ•°æ®ï¼›size ä»£è¡¨è¡¨ä¸­çš„å­˜å‚¨æ•°ç›®ï¼› threshold ä»£è¡¨éœ€è¦æ‰©å®¹æ—¶å¯¹åº” size çš„é˜ˆå€¼ã€‚</p><p>é“¾æ¥ï¼š<a href="https://www.jianshu.com/p/acfd2239c9f4" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/acfd2239c9f4<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>æ¥æºï¼šç®€ä¹¦</p><p>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p><strong>ï¼ˆ2ï¼‰ å­˜å‚¨ç»“æ„ - Entry</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/*
 * Entryç»§æ‰¿WeakReferenceï¼Œå¹¶ä¸”ç”¨ThreadLocalä½œä¸ºkey.
 * å¦‚æœkeyä¸ºnull(entry.get() == null)ï¼Œæ„å‘³ç€keyä¸å†è¢«å¼•ç”¨ï¼Œ
 * å› æ­¤è¿™æ—¶å€™entryä¹Ÿå¯ä»¥ä»tableä¸­æ¸…é™¤ã€‚
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** The value associated with this ThreadLocal. */</span>
    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ åœ¨ThreadLocalMapä¸­ï¼Œä¹Ÿæ˜¯ç”¨Entryæ¥ä¿å­˜K-Vç»“æ„æ•°æ®çš„ã€‚ä¸è¿‡Entryä¸­çš„keyåªèƒ½æ˜¯ThreadLocalå¯¹è±¡ï¼Œè¿™ç‚¹åœ¨æ„é€ æ–¹æ³•ä¸­å·²ç»é™å®šæ­»äº†ã€‚</p><p>â€‹ å¦å¤–ï¼ŒEntryç»§æ‰¿WeakReferenceï¼Œä¹Ÿå°±æ˜¯keyï¼ˆThreadLocalï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œå…¶ç›®çš„æ˜¯å°†ThreadLocalå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘ã€‚</p><h3 id="_5-2-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" tabindex="-1"><a class="header-anchor" href="#_5-2-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" aria-hidden="true">#</a> 5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼</h3><p>â€‹ æœ‰äº›ç¨‹åºå‘˜åœ¨ä½¿ç”¨ThreadLocalçš„è¿‡ç¨‹ä¸­ä¼šå‘ç°æœ‰å†…å­˜æ³„æ¼çš„æƒ…å†µå‘ç”Ÿï¼Œå°±çŒœæµ‹è¿™ä¸ªå†…å­˜æ³„æ¼è·ŸEntryä¸­ä½¿ç”¨äº†å¼±å¼•ç”¨çš„keyæœ‰å…³ç³»ã€‚è¿™ä¸ªç†è§£å…¶å®æ˜¯ä¸å¯¹çš„ã€‚</p><p>â€‹ æˆ‘ä»¬å…ˆæ¥å›é¡¾è¿™ä¸ªé—®é¢˜ä¸­æ¶‰åŠçš„å‡ ä¸ªåè¯æ¦‚å¿µï¼Œå†æ¥åˆ†æé—®é¢˜ã€‚</p><p><strong>ï¼ˆ1ï¼‰ å†…å­˜æ³„æ¼ç›¸å…³æ¦‚å¿µ</strong></p><ul><li>Memory overflow:å†…å­˜æº¢å‡ºï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æä¾›ç”³è¯·è€…ä½¿ç”¨ã€‚</li><li>Memory leak: å†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­å·±åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœã€‚å†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</li></ul><p><strong>ï¼ˆ2ï¼‰ å¼±å¼•ç”¨ç›¸å…³æ¦‚å¿µ</strong></p><p>â€‹ Javaä¸­çš„å¼•ç”¨æœ‰4ç§ç±»å‹ï¼š å¼ºã€è½¯ã€å¼±ã€è™šã€‚å½“å‰è¿™ä¸ªé—®é¢˜ä¸»è¦æ¶‰åŠåˆ°å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼š</p><p>â€‹ <strong>å¼ºå¼•ç”¨ï¼ˆâ€œStrongâ€ Referenceï¼‰</strong>ï¼Œå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶è¿™ç§å¯¹è±¡ã€‚</p><p>â€‹ <strong>å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰</strong>ï¼Œåƒåœ¾å›æ”¶å™¨ä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚</p><p><strong>ï¼ˆ3ï¼‰ å¦‚æœkeyä½¿ç”¨å¼ºå¼•ç”¨</strong></p><p>â€‹ å‡è®¾ThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šå‡ºç°å†…å­˜æ³„æ¼å—ï¼Ÿ</p><p>â€‹ æ­¤æ—¶ThreadLocalçš„å†…å­˜å›¾ï¼ˆå®çº¿è¡¨ç¤ºå¼ºå¼•ç”¨ï¼‰å¦‚ä¸‹ï¼š</p><p><img src="/assets/009.84524eab.png" alt="1582902708234"></p><p>â€‹ å‡è®¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨å®ŒThreadLocal ï¼ŒthreadLocal Refè¢«å›æ”¶äº†ã€‚</p><p>â€‹ ä½†æ˜¯å› ä¸ºthreadLocalMapçš„Entryå¼ºå¼•ç”¨äº†threadLocalï¼Œé€ æˆthreadLocalæ— æ³•è¢«å›æ”¶ã€‚</p><p>â€‹ åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntryä»¥åŠCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå§‹ç»ˆæœ‰å¼ºå¼•ç”¨é“¾ threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entryï¼ŒEntryå°±ä¸ä¼šè¢«å›æ”¶ï¼ˆEntryä¸­åŒ…æ‹¬äº†ThreadLocalå®ä¾‹å’Œvalueï¼‰ï¼Œå¯¼è‡´Entryå†…å­˜æ³„æ¼ã€‚</p><p>â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼ŒThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼ºå¼•ç”¨ï¼Œ æ˜¯æ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼çš„ã€‚</p><p><img src="/assets/555.b6c3edca.png" alt="image-20230412001351665"></p><p><strong>ï¼ˆ5ï¼‰å¦‚æœkeyä½¿ç”¨å¼±å¼•ç”¨</strong></p><p>â€‹ é‚£ä¹ˆThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œä¼šå‡ºç°å†…å­˜æ³„æ¼å—ï¼Ÿ</p><p>â€‹ æ­¤æ—¶ThreadLocalçš„å†…å­˜å›¾ï¼ˆå®çº¿è¡¨ç¤ºå¼ºå¼•ç”¨ï¼Œè™šçº¿è¡¨ç¤ºå¼±å¼•ç”¨ï¼‰å¦‚ä¸‹ï¼š</p><p><img src="/assets/006.09f641cd.png" alt="1582907143471"></p><p>â€‹</p><p>â€‹ åŒæ ·å‡è®¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨å®ŒThreadLocal ï¼ŒthreadLocal Refè¢«å›æ”¶äº†ã€‚</p><p>â€‹ ç”±äºThreadLocalMapåªæŒæœ‰ThreadLocalçš„å¼±å¼•ç”¨ï¼Œæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘threadlocalå®ä¾‹, æ‰€ä»¥threadlocalå°±å¯ä»¥é¡ºåˆ©è¢«gcå›æ”¶ï¼Œæ­¤æ—¶Entryä¸­çš„key=nullã€‚</p><p>â€‹ ä½†æ˜¯åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntryä»¥åŠCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œä¹Ÿå­˜åœ¨æœ‰å¼ºå¼•ç”¨é“¾ threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry -&gt; value ï¼Œvalueä¸ä¼šè¢«å›æ”¶ï¼Œ è€Œè¿™å—valueæ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°äº†ï¼Œå¯¼è‡´valueå†…å­˜æ³„æ¼ã€‚</p><p>â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼ŒThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œ ä¹Ÿæœ‰å¯èƒ½å†…å­˜æ³„æ¼ã€‚</p><p><strong>ï¼ˆ6ï¼‰å‡ºç°å†…å­˜æ³„æ¼çš„çœŸå®åŸå› </strong></p><p>â€‹ æ¯”è¾ƒä»¥ä¸Šä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œå†…å­˜æ³„æ¼çš„å‘ç”Ÿè·ŸThreadLocalMapä¸­çš„keyæ˜¯å¦ä½¿ç”¨å¼±å¼•ç”¨æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚é‚£ä¹ˆå†…å­˜æ³„æ¼çš„çš„çœŸæ­£åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>â€‹ ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œåœ¨ä»¥ä¸Šä¸¤ç§å†…å­˜æ³„æ¼çš„æƒ…å†µä¸­ï¼Œéƒ½æœ‰ä¸¤ä¸ªå‰æï¼š</p><pre><code> 1. æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntry
 2. CurrentThreadä¾ç„¶è¿è¡Œ
</code></pre><p>â€‹ ç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œåªè¦åœ¨ä½¿ç”¨å®ŒThreadLocalï¼Œè°ƒç”¨å…¶removeæ–¹æ³•åˆ é™¤å¯¹åº”çš„Entryï¼Œå°±èƒ½é¿å…å†…å­˜æ³„æ¼ã€‚</p><p>â€‹ ç¬¬äºŒç‚¹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œ ç”±äºThreadLocalMapæ˜¯Threadçš„ä¸€ä¸ªå±æ€§ï¼Œè¢«å½“å‰çº¿ç¨‹æ‰€å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨å®ŒThreadLocalçš„ä½¿ç”¨ï¼Œå¦‚æœå½“å‰Threadä¹Ÿéšä¹‹æ‰§è¡Œç»“æŸï¼ŒThreadLocalMapè‡ªç„¶ä¹Ÿä¼šè¢«gcå›æ”¶ï¼Œä»æ ¹æºä¸Šé¿å…äº†å†…å­˜æ³„æ¼ã€‚</p><p>â€‹ ç»¼ä¸Šï¼Œ<strong>ThreadLocalå†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯</strong>ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p><strong>ï¼ˆ7ï¼‰ ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨</strong></p><p>â€‹ æ ¹æ®åˆšæ‰çš„åˆ†æ, æˆ‘ä»¬çŸ¥é“äº†ï¼š æ— è®ºThreadLocalMapä¸­çš„keyä½¿ç”¨å“ªç§ç±»å‹å¼•ç”¨éƒ½æ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼ï¼Œè·Ÿä½¿ç”¨å¼±å¼•ç”¨æ²¡æœ‰å…³ç³»ã€‚</p><p>â€‹ è¦é¿å…å†…å­˜æ³„æ¼æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li><p>ä½¿ç”¨å®ŒThreadLocalï¼Œè°ƒç”¨å…¶removeæ–¹æ³•åˆ é™¤å¯¹åº”çš„Entry</p></li><li><p>ä½¿ç”¨å®ŒThreadLocalï¼Œå½“å‰Threadä¹Ÿéšä¹‹è¿è¡Œç»“æŸ</p><p>ç›¸å¯¹ç¬¬ä¸€ç§æ–¹å¼ï¼Œç¬¬äºŒç§æ–¹å¼æ˜¾ç„¶æ›´ä¸å¥½æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œçº¿ç¨‹ç»“æŸæ˜¯ä¸ä¼šé”€æ¯çš„ã€‚</p></li></ol><p>â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è®°å¾—åœ¨ä½¿ç”¨å®ŒThreadLocalåŠæ—¶çš„è°ƒç”¨removeï¼Œæ— è®ºkeyæ˜¯å¼ºå¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨éƒ½ä¸ä¼šæœ‰é—®é¢˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆkeyè¦ç”¨å¼±å¼•ç”¨å‘¢ï¼Ÿ</p><p>â€‹ äº‹å®ä¸Šï¼Œåœ¨ThreadLocalMapä¸­çš„set/getEntryæ–¹æ³•ä¸­ï¼Œä¼šå¯¹keyä¸ºnullï¼ˆä¹Ÿå³æ˜¯ThreadLocalä¸ºnullï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸ºnullçš„è¯ï¼Œé‚£ä¹ˆæ˜¯ä¼šå¯¹valueç½®ä¸ºnullçš„ã€‚</p><p>â€‹ è¿™å°±æ„å‘³ç€ä½¿ç”¨å®ŒThreadLocalï¼ŒCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå°±ç®—å¿˜è®°è°ƒç”¨removeæ–¹æ³•ï¼Œ<strong>å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœ</strong>ï¼šå¼±å¼•ç”¨çš„ThreadLocalä¼šè¢«å›æ”¶ï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨set,get,removeä¸­çš„ä»»ä¸€æ–¹æ³•çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ï¼Œä»è€Œé¿å…å†…å­˜æ³„æ¼ã€‚</p><h3 id="_5-3-hashå†²çªçš„è§£å†³" tabindex="-1"><a class="header-anchor" href="#_5-3-hashå†²çªçš„è§£å†³" aria-hidden="true">#</a> 5.3 hashå†²çªçš„è§£å†³</h3><p>â€‹ hashå†²çªçš„è§£å†³æ˜¯Mapä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ã€‚æˆ‘ä»¬ä»¥hashå†²çªçš„è§£å†³ä¸ºçº¿ç´¢ï¼Œæ¥ç ”ç©¶ä¸€ä¸‹ThreadLocalMapçš„æ ¸å¿ƒæºç ã€‚</p><p><strong>ï¼ˆ1ï¼‰ é¦–å…ˆä»ThreadLocalçš„set() æ–¹æ³•å…¥æ‰‹</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">//è°ƒç”¨äº†ThreadLocalMapçš„setæ–¹æ³•</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è°ƒç”¨äº†ThreadLocalMapçš„æ„é€ æ–¹æ³•</span>
        t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åˆšæ‰åˆ†æè¿‡, å…¶ä½œç”¨æ˜¯è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡ :</p><p>â€‹ A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹ B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ°Mapä¸­ï¼ˆå½“å‰ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyï¼‰</p><p>â€‹ <strong>(è¿™é‡Œè°ƒç”¨äº†ThreadLocalMapçš„setæ–¹æ³•)</strong></p><p>â€‹ C. å¦‚æœMapä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º Mapï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</p><p>â€‹ <strong>(è¿™é‡Œè°ƒç”¨äº†ThreadLocalMapçš„æ„é€ æ–¹æ³•)</strong></p><p>è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªåœ°æ–¹åˆ†åˆ«æ¶‰åŠåˆ°ThreadLocalMapçš„ä¸¤ä¸ªæ–¹æ³•, æˆ‘ä»¬æ¥ç€åˆ†æè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>**ï¼ˆ2ï¼‰æ„é€ æ–¹æ³•<code>ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue)**</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token comment">/*
  * firstKey : æœ¬ThreadLocalå®ä¾‹(this)
  * firstValue ï¼š è¦ä¿å­˜çš„çº¿ç¨‹æœ¬åœ°å˜é‡
  */</span>
<span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> firstKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆå§‹åŒ–table</span>
        table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span><span class="token punctuation">[</span><span class="token constant">INITIAL_CAPACITY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¡ç®—ç´¢å¼•(é‡ç‚¹ä»£ç ï¼‰</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> firstKey<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token constant">INITIAL_CAPACITY</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®å€¼</span>
        table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span><span class="token punctuation">(</span>firstKey<span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®é˜ˆå€¼</span>
        <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token constant">INITIAL_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ æ„é€ å‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„ï¼Œç„¶åè®¡ç®—å‡ºfirstKeyå¯¹åº”çš„ç´¢å¼•ï¼Œç„¶åå­˜å‚¨åˆ°tableä¸­ï¼Œå¹¶è®¾ç½®sizeå’Œthresholdã€‚</p><p>â€‹ <strong>é‡ç‚¹åˆ†æ</strong>ï¼š <code>int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1)</code>ã€‚</p><p>a. å…³äº<code>firstKey.threadLocalHashCode</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadLocalHashCode <span class="token operator">=</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//AtomicIntegeræ˜¯ä¸€ä¸ªæä¾›åŸå­æ“ä½œçš„Integerç±»ï¼Œé€šè¿‡çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ“ä½œåŠ å‡,é€‚åˆé«˜å¹¶å‘æƒ…å†µä¸‹çš„ä½¿ç”¨</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> nextHashCode <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//ç‰¹æ®Šçš„hashå€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªAtomicIntegerç±»å‹ï¼Œæ¯æ¬¡è·å–å½“å‰å€¼å¹¶åŠ ä¸ŠHASH_INCREMENTï¼Œ<code>HASH_INCREMENT = 0x61c88647</code>,è¿™ä¸ªå€¼è·Ÿæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ˆé»„é‡‘åˆ†å‰²æ•°ï¼‰æœ‰å…³ï¼Œå…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è®©å“ˆå¸Œç èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨2çš„næ¬¡æ–¹çš„æ•°ç»„é‡Œ, ä¹Ÿå°±æ˜¯Entry[] tableä¸­ï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å…hashå†²çªã€‚</p><p>b. å…³äº<code>&amp; (INITIAL_CAPACITY - 1)</code></p><p>â€‹ è®¡ç®—hashçš„æ—¶å€™é‡Œé¢é‡‡ç”¨äº†hashCode &amp; (size - 1)çš„ç®—æ³•ï¼Œè¿™ç›¸å½“äºå–æ¨¡è¿ç®—hashCode % sizeçš„ä¸€ä¸ªæ›´é«˜æ•ˆçš„å®ç°ã€‚æ­£æ˜¯å› ä¸ºè¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬è¦æ±‚sizeå¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ï¼Œè¿™ä¹Ÿèƒ½ä¿è¯åœ¨ç´¢å¼•ä¸è¶Šç•Œçš„å‰æä¸‹ï¼Œä½¿å¾—hashå‘ç”Ÿå†²çªçš„æ¬¡æ•°å‡å°ã€‚</p><p><strong>ï¼ˆ3ï¼‰ ThreadLocalMapä¸­çš„setæ–¹æ³•</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">//è®¡ç®—ç´¢å¼•(é‡ç‚¹ä»£ç ï¼Œåˆšæ‰åˆ†æè¿‡äº†ï¼‰</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•æŸ¥æ‰¾å…ƒç´ ï¼ˆé‡ç‚¹ä»£ç ï¼‰
         */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
             e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
             e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// keyä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œ</span>
           <span class="token comment">// å½“å‰æ•°ç»„ä¸­çš„ Entry æ˜¯ä¸€ä¸ªé™ˆæ—§ï¼ˆstaleï¼‰çš„å…ƒç´ </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//ç”¨æ–°å…ƒç´ æ›¿æ¢é™ˆæ—§çš„å…ƒç´ ï¼Œè¿™ä¸ªæ–¹æ³•è¿›è¡Œäº†ä¸å°‘çš„åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span>
                <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//ThreadLocalå¯¹åº”çš„keyä¸å­˜åœ¨å¹¶ä¸”æ²¡æœ‰æ‰¾åˆ°é™ˆæ—§çš„å…ƒç´ ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„Entryã€‚</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * cleanSomeSlotsç”¨äºæ¸…é™¤é‚£äº›e.get()==nullçš„å…ƒç´ ï¼Œ
             * è¿™ç§æ•°æ®keyå…³è”çš„å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œæ‰€ä»¥è¿™ä¸ªEntry(table[index])å¯ä»¥è¢«ç½®nullã€‚
             * å¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½•entry,å¹¶ä¸”å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰(é•¿åº¦çš„2/3)ï¼Œé‚£ä¹ˆè¿›è¡Œ                 * rehashï¼ˆæ‰§è¡Œä¸€æ¬¡å…¨è¡¨çš„æ‰«ææ¸…ç†å·¥ä½œï¼‰
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
                <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
     * è·å–ç¯å½¢æ•°ç»„çš„ä¸‹ä¸€ä¸ªç´¢å¼•
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ä»£ç æ‰§è¡Œæµç¨‹ï¼š</p><p>A. é¦–å…ˆè¿˜æ˜¯æ ¹æ®keyè®¡ç®—å‡ºç´¢å¼• iï¼Œç„¶åæŸ¥æ‰¾iä½ç½®ä¸Šçš„Entryï¼Œ</p><p>B. è‹¥æ˜¯Entryå·²ç»å­˜åœ¨å¹¶ä¸”keyç­‰äºä¼ å…¥çš„keyï¼Œé‚£ä¹ˆè¿™æ—¶å€™ç›´æ¥ç»™è¿™ä¸ªEntryèµ‹æ–°çš„valueå€¼,</p><p>C. è‹¥æ˜¯Entryå­˜åœ¨ï¼Œä½†æ˜¯keyä¸ºnullï¼Œåˆ™è°ƒç”¨replaceStaleEntryæ¥æ›´æ¢è¿™ä¸ªkeyä¸ºç©ºçš„Entry,</p><p>D. ä¸æ–­å¾ªç¯æ£€æµ‹ï¼Œç›´åˆ°é‡åˆ°ä¸ºnullçš„åœ°æ–¹ï¼Œè¿™æ—¶å€™è¦æ˜¯è¿˜æ²¡åœ¨å¾ªç¯è¿‡ç¨‹ä¸­returnï¼Œé‚£ä¹ˆå°±åœ¨è¿™ä¸ªnullçš„ä½ç½®æ–°å»ºä¸€ä¸ªEntryï¼Œå¹¶ä¸”æ’å…¥ï¼ŒåŒæ—¶sizeå¢åŠ 1ã€‚</p><p>â€‹ æœ€åè°ƒç”¨cleanSomeSlotsï¼Œæ¸…ç†keyä¸ºnullçš„Entryï¼Œæœ€åè¿”å›æ˜¯å¦æ¸…ç†äº†Entryï¼Œæ¥ä¸‹æ¥å†åˆ¤æ–­sz æ˜¯å¦&gt;= thresgoldè¾¾åˆ°äº†rehashçš„æ¡ä»¶ï¼Œè¾¾åˆ°çš„è¯å°±ä¼šè°ƒç”¨rehashå‡½æ•°æ‰§è¡Œä¸€æ¬¡å…¨è¡¨çš„æ‰«ææ¸…ç†ã€‚</p><p><strong>é‡ç‚¹åˆ†æ</strong> ï¼š ThreadLocalMapä½¿ç”¨<code>çº¿æ€§æ¢æµ‹æ³•</code>æ¥è§£å†³å“ˆå¸Œå†²çªçš„ã€‚</p><p>â€‹ è¯¥æ–¹æ³•ä¸€æ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ•´ä¸ªç©ºé—´éƒ½æ‰¾ä¸åˆ°ç©ºä½™çš„åœ°å€ï¼Œåˆ™äº§ç”Ÿæº¢å‡ºã€‚</p><p>â€‹ ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å½“å‰tableé•¿åº¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¡ç®—å‡ºæ¥keyçš„hashå€¼ä¸º14ï¼Œå¦‚æœtable[14]ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶keyä¸å½“å‰keyä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™å°†14åŠ 1å¾—åˆ°15ï¼Œå–table[15]è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ°0ï¼Œå–table[0],ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ã€‚</p><p>â€‹ æŒ‰ç…§ä¸Šé¢çš„æè¿°ï¼Œå¯ä»¥æŠŠEntry[] tableçœ‹æˆä¸€ä¸ªç¯å½¢æ•°ç»„ã€‚</p><p><img src="/assets/444.6abdfd7d.png" alt="image-20230412001245244"></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/Ragnarokoo/LearningNotes/edit/master/src/notes/javacore/java/ThreadLocalå…¨é¢è§£æ.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ã€Githubã€‘ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ã€Githubã€‘ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><!----></footer><nav class="page-nav"><a href="/notes/javacore/java/Java.html" class="nav-link prev" aria-label="Java Language Core Notes"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Java Language Core Notes</div></a><a href="/notes/javacore/java/%E5%BD%BB%E5%BA%95%E5%BC%84%E6%87%82StringBuffer%E4%B8%8EStringBuilder%E7%9A%84%E5%8C%BA%E5%88%AB.html" class="nav-link next" aria-label="å½»åº•å¼„æ‡‚StringBufferä¸StringBuilderçš„åŒºåˆ«"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">å½»åº•å¼„æ‡‚StringBufferä¸StringBuilderçš„åŒºåˆ«<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.9b10ba0a.js" defer></script>
  </body>
</html>
