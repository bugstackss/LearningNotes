import{_ as i}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as t,c as l,d as a,e,b as r,a as p,r as o}from"./app.9b10ba0a.js";const c="/assets/2023-03-31-23-16-44-image.0ab189d9.png",n="/assets/2023-03-31-23-16-56-image.07721d81.png",d="/assets/2023-03-30-23-11-18-image.7356791b.png",h="/assets/2023-03-30-23-18-08-image.09883203.png",m="/assets/2023-03-30-23-23-34-image.9ecee11c.png",g="/assets/2023-03-30-23-24-07-image.62c47adf.png",_="/assets/2023-03-30-23-24-33-image.6d034590.png",f="/assets/2023-03-30-23-24-54-image.fa6d181f.png",u="/assets/2023-03-30-23-25-18-image.a8eacee0.png",b="/assets/2023-03-30-23-25-42-image.418a2f4a.png",v="/assets/2023-03-30-23-26-06-image.53c13956.png",x="/assets/2023-03-30-23-26-28-image.ced8bfc9.png",k="/assets/2023-03-30-23-26-50-image.4a07d07b.png",q="/assets/2023-03-30-23-27-16-image.33cfad2c.png",I="/assets/2023-03-30-23-27-29-image.04b40bc8.png",S="/assets/2023-03-30-23-28-05-image.8c22d7f4.png",P="/assets/2023-03-30-23-31-48-image.eeda3a37.png",B="/assets/2023-03-30-23-32-05-image.2136da3f.png",R="/assets/2023-03-30-23-32-40-image.13a5a5a7.png",V="/assets/2023-03-30-23-32-49-image.bbf954f0.png",M="/assets/2023-03-30-23-32-57-image.1ea212dd.png",N="/assets/2023-03-30-23-33-52-image.1bd55ed8.png",w="/assets/2023-03-30-23-34-38-image.5f8eb288.png",D="/assets/2023-03-30-23-36-05-image.03984d71.png",E="/assets/2023-03-30-23-36-17-image.5b9dfaec.png",y="/assets/2023-03-30-23-36-28-image.b306f135.png",L="/assets/2023-03-30-23-38-10-image.5e31e609.png",z="/assets/2023-03-30-23-40-33-image.1cec95cc.png",A="/assets/2023-03-30-23-40-43-image.ce5f1d66.png",C="/assets/2023-03-30-23-40-52-image.3d81424d.png",F="/assets/2023-03-30-23-41-55-image.e19d8122.png",G="/assets/2023-03-30-23-42-11-image.0a13e9ae.png",O="/assets/2023-03-30-23-42-19-image.fd9ff6c1.png",T="/assets/2023-03-31-15-22-35-image.76f4155c.png",Y="/assets/2023-03-31-15-23-04-image.c9f12e28.png",j="/assets/2023-03-31-15-23-15-image.2126b84a.png",H="/assets/2023-03-31-15-23-27-image.61cc3afa.png",J="/assets/2023-03-31-15-24-27-image.173972b5.png",K="/assets/2023-03-31-15-24-36-image.00dbc4ff.png",Q="/assets/2023-03-31-15-25-22-image.87b6a9a9.png",U="/assets/2023-04-01-00-46-32-image.3ae12de0.png",W="/assets/2023-04-01-00-47-53-image.6362f922.png",X="/assets/2023-03-31-23-24-30-image.16243e33.png",Z="/assets/2023-03-31-23-30-02-image.a00f796e.png",$={},aa=a("h2",{id:"_01、是什么",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#_01、是什么","aria-hidden":"true"},"#"),e(" 01、是什么？")],-1),ea={href:"https://redis.io/docs/management/replication/",target:"_blank",rel:"noopener noreferrer"},sa=p('<p>一句话</p><ul><li><p>就是主从复制，master以写为主，Slave以读为主</p></li><li><p>当master数据变化的时候，自动将新的数据异步同步到其他Slave数据库</p></li></ul><p><img src="'+c+'" alt=""></p><p><img src="'+n+'" alt=""></p><h2 id="_02、能干嘛" tabindex="-1"><a class="header-anchor" href="#_02、能干嘛" aria-hidden="true">#</a> 02、能干嘛？</h2><ul><li><p>读写分离</p></li><li><p>容灾恢复</p></li><li><p>数据备份</p></li><li><p>水平扩容支撑高并发</p></li></ul><h2 id="_03、怎么玩" tabindex="-1"><a class="header-anchor" href="#_03、怎么玩" aria-hidden="true">#</a> 03、怎么玩？</h2><h3 id="配从-库-不配主-库" tabindex="-1"><a class="header-anchor" href="#配从-库-不配主-库" aria-hidden="true">#</a> 配从（库）不配主（库）</h3><h3 id="权限细节-重要" tabindex="-1"><a class="header-anchor" href="#权限细节-重要" aria-hidden="true">#</a> 权限细节，重要</h3><ul><li><p>master如果配置了requirepass参数，需要密码登录</p></li><li><p>那么slave就要配置masterauth来设置校验密码，否则的话master就会拒绝slave的访问请求</p></li></ul><p><img src="'+d+'" alt=""></p><h3 id="基本命令操作" tabindex="-1"><a class="header-anchor" href="#基本命令操作" aria-hidden="true">#</a> 基本命令操作</h3><h4 id="info-replication" tabindex="-1"><a class="header-anchor" href="#info-replication" aria-hidden="true">#</a> info replication</h4><p>可以查看复制节点的主从关系和配置信息</p><h4 id="replicaof-主库ip-主库端口" tabindex="-1"><a class="header-anchor" href="#replicaof-主库ip-主库端口" aria-hidden="true">#</a> replicaof 主库IP 主库端口</h4><p>一般写入进redis.conf配置文件内</p><h4 id="slaveof-主库ip-主库端口" tabindex="-1"><a class="header-anchor" href="#slaveof-主库ip-主库端口" aria-hidden="true">#</a> slaveof 主库IP 主库端口</h4><ul><li><p>每次与master断开之后，都需要重新连接，除非你配置进redis.conf文件</p></li><li><p>在运行期间修改slave节点的信息，如果改数据库已经是某个主数据库的从数据库，那么会停止和原主数据库的同步关系<code>转而和新的主数据库同步，重新拜码头</code></p></li></ul><h4 id="slaveof-no-one" tabindex="-1"><a class="header-anchor" href="#slaveof-no-one" aria-hidden="true">#</a> slaveof no one</h4><p>使用当前数据库停止与其他数据库的同步，<code>转成主数据库，自立为王</code></p><h2 id="_04、案例说明" tabindex="-1"><a class="header-anchor" href="#_04、案例说明" aria-hidden="true">#</a> 04、案例说明</h2><h3 id="架构说明" tabindex="-1"><a class="header-anchor" href="#架构说明" aria-hidden="true">#</a> 架构说明</h3><ol><li>一个Master两个Slave</li></ol><p><img src="'+h+'" alt=""></p><p>3台虚拟机，每台都安装redis</p><ol start="2"><li>拷贝多个redis.conf文件</li></ol><ul><li><p>redis6379.conf</p></li><li><p>redis6380.conf</p></li><li><p>redis6381.conf</p></li></ul><h3 id="小口诀" tabindex="-1"><a class="header-anchor" href="#小口诀" aria-hidden="true">#</a> 小口诀</h3><ol><li><p>三边网络互相ping通且注意防火墙配置</p></li><li><p>三大命令</p></li></ol><ul><li>主从复制</li></ul><blockquote><p>replicaof 主库IP 主库端口</p><p><code>配从(库)不配主(库)</code></p></blockquote><ul><li>改换门庭</li></ul><blockquote><p>slaveof 新主库IP 新主库端口</p></blockquote><ul><li>自立为王</li></ul><blockquote><p>slaveof no one</p></blockquote><h3 id="修改配置文件细节操作" tabindex="-1"><a class="header-anchor" href="#修改配置文件细节操作" aria-hidden="true">#</a> 修改配置文件细节操作</h3><blockquote><p>redis6379.conf为例，步骤：</p></blockquote><ol><li>开启daemonize yes</li></ol><p><img src="'+m+'" alt=""></p><ol start="2"><li>注释掉bind 127.0.0.1</li></ol><p><img src="'+g+'" alt=""></p><ol start="3"><li>protected-mode no</li></ol><p><img src="'+_+'" alt=""></p><ol start="4"><li>指定端口</li></ol><p><img src="'+f+'" alt=""></p><ol start="5"><li>指定当前工作目录，dir</li></ol><p><img src="'+u+'" alt=""></p><ol start="6"><li>pid文件名字，pidfile</li></ol><p><img src="'+b+'" alt=""></p><ol start="7"><li>log文件名字，logfile</li></ol><p><img src="'+v+'" alt=""></p><ol start="8"><li>requirepass</li></ol><p><img src="'+x+'" alt=""></p><ol start="9"><li>dump.rdb名字</li></ol><p><img src="'+k+'" alt=""></p><ol start="10"><li>aof文件，appendfilename</li></ol><p><img src="'+q+'" alt=""></p><p>本步骤可选，非必须</p><p><img src="'+I+'" alt=""></p><ol start="11"><li><code>从机访问主机的同行密码masterauth，必须</code></li></ol><p><img src="'+S+'" alt=""></p><p>从机必须配置，主机不用</p><h3 id="常用3招" tabindex="-1"><a class="header-anchor" href="#常用3招" aria-hidden="true">#</a> 常用3招</h3><h4 id="一主二仆" tabindex="-1"><a class="header-anchor" href="#一主二仆" aria-hidden="true">#</a> 一主二仆</h4><h5 id="方案1-配置文件固定写死" tabindex="-1"><a class="header-anchor" href="#方案1-配置文件固定写死" aria-hidden="true">#</a> 方案1：配置文件固定写死</h5><ol><li>配置文件执行</li></ol><p>replicaof 主库IP 主库端口</p><ol start="2"><li><code>配从(库)不配主(库)</code></li></ol><ul><li>配置从机6380</li></ul><p><img src="'+P+'" alt=""></p><ul><li>配置从机6381</li></ul><p><img src="'+B+'" alt=""></p><ol start="3"><li>先master后两台slave依次启动</li></ol><p><img src="'+R+'" alt=""></p><p><img src="'+V+'" alt=""></p><p><img src="'+M+'" alt=""></p><ol start="4"><li>主从关系查看</li></ol><ul><li><p>日志</p><ul><li><p>主机日志</p><p>vim 6379.log</p><p><img src="'+N+'" alt=""></p></li><li><p>备机日志</p><p><img src="'+w+'" alt=""></p></li></ul></li><li><p>命令</p><ul><li><p>info replication命令查看</p><p><img src="'+D+'" alt=""></p><p><img src="'+E+'" alt=""></p><p><img src="'+y+'" alt=""></p></li></ul></li></ul><h5 id="主从问题演示" tabindex="-1"><a class="header-anchor" href="#主从问题演示" aria-hidden="true">#</a> 主从问题演示</h5><ol><li>从机可以执行写命令吗？</li></ol><p><img src="'+L+'" alt=""></p><ol start="2"><li>从机切入点问题</li></ol><p><code>slave是从头开始复制还是从切入点开始复制?</code></p><p>master启动，写到k3</p><p>slave1跟着master同时启动，跟着写到k3</p><p>slave2写到k3后才启动，那之前的是否也可以复制？</p><p><code>Y，首次一锅端，后续跟随，master写，slave跟</code></p><ol start="3"><li>主机shutdown后，从机会上位吗？</li></ol><p>主机shutdown后情况如何？从机是上位还是原地待命</p><p><code>从机不动，原地待命，从机数据可以正常使用；等待主机重启动归来</code></p><p><img src="'+z+'" alt=""></p><p><img src="'+A+'" alt=""></p><p><img src="'+C+'" alt=""></p><ol start="4"><li>主机shutdown后，重启后主从关系还在吗？从机还能否顺利复制？</li></ol><p><code>青山依旧在</code></p><p><img src="'+F+'" alt=""></p><p><img src="'+G+'" alt=""></p><p><img src="'+O+'" alt=""></p><ol start="5"><li>某台从机down后，master继续，从机重启后它能跟上大部队吗？</li></ol><h5 id="方案2-命令操作手动指定" tabindex="-1"><a class="header-anchor" href="#方案2-命令操作手动指定" aria-hidden="true">#</a> 方案2：命令操作手动指定</h5><ul><li>从机停机去掉配置文件中的配置项，3台目前都是主机状态，各不从属</li></ul><p><img src="'+T+'" alt=""></p><ul><li>3台master</li></ul><p><img src="'+Y+'" alt=""></p><p><img src="'+j+'" alt=""></p><p><img src="'+H+'" alt=""></p><ul><li>预设的从机上执行命令</li></ul><blockquote><p>slaveof 主库IP 主库端口</p><p>效果</p></blockquote><p><img src="'+J+'" alt=""></p><p><img src="'+K+'" alt=""></p><ul><li>用命令使用的话，2台从机重启后，关系还在吗？</li></ul><p><img src="'+Q+'" alt=""></p><h5 id="配置-vs-命令的区别-当堂实验讲解" tabindex="-1"><a class="header-anchor" href="#配置-vs-命令的区别-当堂实验讲解" aria-hidden="true">#</a> 配置 VS 命令的区别，当堂实验讲解</h5><ul><li><p>配置，持久稳定</p></li><li><p>命令，档次生效</p></li></ul><h4 id="薪火相传" tabindex="-1"><a class="header-anchor" href="#薪火相传" aria-hidden="true">#</a> 薪火相传</h4><ul><li><p>上一个slave可以是下一个slave的master，slave同样可以接收其他slaves的连接和同步请求，那么该slave作为了链条中下一个master，可以减轻主master的写压力</p></li><li><p>中途变更转向：会清除之前的数据，重新建立拷贝最新的</p></li><li><p>slaveof 新主库IP 新主库端口</p></li></ul><p><img src="'+U+'" alt=""></p><h4 id="反客为主" tabindex="-1"><a class="header-anchor" href="#反客为主" aria-hidden="true">#</a> 反客为主</h4><p><code>SLAVEOF no one </code></p><p>是当前数据库停止与其他数据库同步，转为主数据库master</p><p><img src="'+W+'" alt=""></p><h2 id="_05、复制原理和工作流程" tabindex="-1"><a class="header-anchor" href="#_05、复制原理和工作流程" aria-hidden="true">#</a> 05、复制原理和工作流程</h2><h3 id="slave启动-同步初请" tabindex="-1"><a class="header-anchor" href="#slave启动-同步初请" aria-hidden="true">#</a> slave启动，同步初请</h3><p>slave启动成功连接到master后发送一个sync命令</p><p>slave首次全新连接master，一次完全同步（全量复制将被自动执行，slave自身原有的会被master数据覆盖清除）</p><h3 id="首次连接-全量复制" tabindex="-1"><a class="header-anchor" href="#首次连接-全量复制" aria-hidden="true">#</a> 首次连接，全量复制</h3><p>master节点收到sync命令后会开始在后台保存快照（即RDB持久化，主从复制时会触发RDB），同时收集所有接收到的用于修改数据集命令缓存起来，master节点执行RDB持久化完后，master将RDB快照文件和所有缓存的命令发送到所有slave，以完成一次性完全同步</p><p>而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化</p><h3 id="心跳持续-保持通信" tabindex="-1"><a class="header-anchor" href="#心跳持续-保持通信" aria-hidden="true">#</a> 心跳持续，保持通信</h3><blockquote><p>repl-ping-replica-period 10</p></blockquote><p><code>master发出PING包的周期，默认是10秒</code></p><p><img src="'+X+'" alt=""></p><h3 id="进入平稳-增量复制" tabindex="-1"><a class="header-anchor" href="#进入平稳-增量复制" aria-hidden="true">#</a> 进入平稳，增量复制</h3><p>Master继续将新的所有收集到的修改命令自动依次传给slave，完成同步</p><h3 id="从机下线-重连续传" tabindex="-1"><a class="header-anchor" href="#从机下线-重连续传" aria-hidden="true">#</a> 从机下线，重连续传</h3><p>master会检查backlog里面的offset，master和slave都会保存一个复制的offset还有一个masterId，offset是保存在backlog中的。<code>Master只会把已经复制的offset后面的数据复制给Slave，类似断电续传</code></p><h2 id="_06、复制的缺点" tabindex="-1"><a class="header-anchor" href="#_06、复制的缺点" aria-hidden="true">#</a> 06、复制的缺点</h2><h3 id="复制延时-信号衰减" tabindex="-1"><a class="header-anchor" href="#复制延时-信号衰减" aria-hidden="true">#</a> 复制延时，信号衰减</h3><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p><p><img src="'+Z+'" alt=""></p><h3 id="master挂了如何办" tabindex="-1"><a class="header-anchor" href="#master挂了如何办" aria-hidden="true">#</a> master挂了如何办？</h3><ul><li><p>默认情况下，不会再slave节点中自动重选一个master</p></li><li><p>那每次都要人工干预？</p></li><li><blockquote><p>无人值守安装变成刚需</p></blockquote></li></ul>',142);function ia(ta,la){const s=o("ExternalLinkIcon");return t(),l("div",null,[aa,a("p",null,[e("官网地址："),a("a",ea,[e("https://redis.io/docs/management/replication/"),r(s)])]),sa])}const oa=i($,[["render",ia],["__file","八、Redis复制（replica）.html.vue"]]);export{oa as default};
