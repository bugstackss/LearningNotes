import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as l,c as o,d as n,e as s,b as e,a as t,r as i}from"./app.9b10ba0a.js";const c="/assets/b40478e2b2c83d7181b9c71cdcae05ea.19b14c76.png",u="/assets/f97d15b5686264d45b46f6f188e99873.399f7ccf.png",r="/assets/ca541262b26f809a0c25014feaa069d7.01b5159e.png",d="/assets/ec45d9d026fee8c83eaaf7bf8cb6893d.0d49d71d.png",k="/assets/f75fcfd2146df03428b9c8c53d13c1f1.6189420d.png",m="/assets/c1d19c5e9724578ee9c8668903685fa4.f786efd9.png",v="/assets/733ad2e18037059045ec80cb59d8d2a3.14e8e369.png",g={},b=n("h2",{id:"_01、sleuth是什么",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_01、sleuth是什么","aria-hidden":"true"},"#"),s(" 01、Sleuth是什么")],-1),h=n("p",null,[n("strong",null,"为什么会出现这个技术？要解决哪些问题？")],-1),_=n("p",null,"在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的的服务节点调用来协同产生最后的请求结果，每一个前段请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现高延时或错误都会引起整个请求最后的失败。",-1),y=n("p",null,[n("img",{src:c,alt:"img"})],-1),f=n("p",null,[n("img",{src:u,alt:"链路多起来的情况"})],-1),z=n("p",null,[n("strong",null,"是什么")],-1),x={href:"https://github.com/spring-cloud/spring-cloud-sleuth",target:"_blank",rel:"noopener noreferrer"},S=n("li",null,"Spring Cloud Sleuth提供了一套完整的服务跟踪的解决方案",-1),j=n("li",null,"在分布式系统中提供追踪解决方案并且兼容支持了zipkin",-1),q=t('<p><strong>解决</strong></p><p><img src="'+r+'" alt="img"></p><blockquote><p>sleuth</p><p>英 [sluːθ] 美 [sluːθ]</p><p>n. 侦探</p></blockquote><h2 id="_02、sleuth之zipkin搭建安装" tabindex="-1"><a class="header-anchor" href="#_02、sleuth之zipkin搭建安装" aria-hidden="true">#</a> 02、Sleuth之zipkin搭建安装</h2><p>1.zipkin</p><p><strong>下载</strong></p>',6),w=n("li",null,"SpringCloud从F版起已不需要自己构建Zipkin Server了，只需调用jar包即可",-1),I={href:"https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/",target:"_blank",rel:"noopener noreferrer"},C={href:"https://repo1.maven.org/maven2/io/zipkin/zipkin-server/",target:"_blank",rel:"noopener noreferrer"},M=n("li",null,"zipkin-server-2.12.9-exec.jar",-1),O=t(`<p><strong>运行jar</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> zipkin-server-2.12.9-exec.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>运行控制台</strong></p>`,3),L={href:"http://localhost:9411/zipkin/",target:"_blank",rel:"noopener noreferrer"},T=t('<p><strong>术语</strong></p><p>完整的调用链路</p><p>表示一请求链路，一条链路通过Trace ld唯一标识，Span标识发起的请求信息，各span通过parent id关联起来</p><p><img src="'+d+'" alt="img"></p><p>—条链路通过Trace ld唯一标识，Span标识发起的请求信息，各span通过parent id关联起来。</p><p><img src="'+k+'" alt="img"></p><p>整个链路的依赖关系如下：</p><p><img src="'+m+`" alt="img"></p><p>名词解释</p><ul><li>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识</li><li>span：表示调用链路来源，通俗的理解span就是一次请求信息</li></ul><h2 id="_03、sleuth链路监控展现" tabindex="-1"><a class="header-anchor" href="#_03、sleuth链路监控展现" aria-hidden="true">#</a> 03、Sleuth链路监控展现</h2><p>2.服务提供者</p><p>cloud-provider-payment8001</p><p>POM</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--包含了sleuth+zipkin--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>YML</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service

  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span> <span class="token comment">#&lt;-------------------------------------关键 </span>
      <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span> <span class="token comment">#&lt;-------------------------------------关键</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
    <span class="token comment">#采样率值介于 0 到 1 之间，1 则表示全部采集</span>
    <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>

  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource            <span class="token comment"># 当前数据源操作类型</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.gjt.mm.mysql.Driver              <span class="token comment"># mysql驱动包</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/db2019<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务类PaymentController</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/zipkin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentZipkin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hi ,i&#39;am paymentzipkin server fall back，welcome to here, O(∩_∩)O哈哈~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.服务消费者(调用方)</p><p>cloue-consumer-order80</p><p>POM</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>YML</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>order<span class="token punctuation">-</span>service
    <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
      <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
    <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
      <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
        <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务类OrderController</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">// ====================&gt; zipkin+sleuth</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/zipkin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentZipkin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8001&quot;</span><span class="token operator">+</span><span class="token string">&quot;/payment/zipkin/&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.依次启动eureka7001/8001/80 - 80调用8001几次测试下</p>`,28),E={href:"http://localhost:9411",target:"_blank",rel:"noopener noreferrer"},N=n("p",null,[n("img",{src:v,alt:"img"})],-1);function P(V,B){const a=i("ExternalLinkIcon");return l(),o("div",null,[b,h,_,y,f,z,n("ul",null,[n("li",null,[n("a",x,[s("https://github.com/spring-cloud/spring-cloud-sleuth"),e(a)])]),S,j]),q,n("ul",null,[w,n("li",null,[n("a",I,[s("https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/"),e(a)])]),n("li",null,[n("a",C,[s("https://repo1.maven.org/maven2/io/zipkin/zipkin-server/"),e(a)]),s(" --新地址")]),M]),O,n("p",null,[n("a",L,[s("http://localhost:9411/zipkin/"),e(a)])]),T,n("p",null,[s("5.打开浏览器访问: "),n("a",E,[s("http://localhost:9411"),e(a)])]),N])}const F=p(g,[["render",P],["__file","十六、SpringCloud Sleuth分布式请求链路追踪.html.vue"]]);export{F as default};
